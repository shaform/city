<!DOCTYPE html>
<html lang="zh" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta name="generator" content="Hugo 0.53" />
  <meta charset="utf-8">
  <title>使用 Go 撰寫 Plurk 噗浪偷偷說網路爬蟲 · 翼之都</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="前言 記得剛開始學習 Go 好像是在 2013 年的時候，不過後來就一直沒太多機會使用。最近剛好想寫個爬蟲，於是就決定用 Go 來練習看看。 這次的目標是 Plurk 噗浪上的「" />

  <meta name="keywords" content="Shaform, open source, Python, machine learning, software" /><link rel="icon" href="https://city.shaform.com/favicon.ico" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
<link rel="stylesheet" href="https://city.shaform.com/css/den.css">




<meta property="og:title" content="使用 Go 撰寫 Plurk 噗浪偷偷說網路爬蟲" />
<meta property="og:description" content="前言 記得剛開始學習 Go 好像是在 2013 年的時候，不過後來就一直沒太多機會使用。最近剛好想寫個爬蟲，於是就決定用 Go 來練習看看。 這次的目標是 Plurk 噗浪上的「" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://city.shaform.com/zh/2019/01/11/plurk-crawler/" />
<meta property="og:image" content="https://city.shaform.com/images/2019/cobweb.jpg" />
<meta property="article:published_time" content="2019-01-11T20:40:00-05:00"/>
<meta property="article:modified_time" content="2019-01-11T20:40:00-05:00"/>

<meta itemprop="name" content="使用 Go 撰寫 Plurk 噗浪偷偷說網路爬蟲">
<meta itemprop="description" content="前言 記得剛開始學習 Go 好像是在 2013 年的時候，不過後來就一直沒太多機會使用。最近剛好想寫個爬蟲，於是就決定用 Go 來練習看看。 這次的目標是 Plurk 噗浪上的「">


<meta itemprop="datePublished" content="2019-01-11T20:40:00-05:00" />
<meta itemprop="dateModified" content="2019-01-11T20:40:00-05:00" />
<meta itemprop="wordCount" content="1304">

  <meta itemprop="image" content="https://city.shaform.com/images/2019/cobweb.jpg">



<meta itemprop="keywords" content="Plurk,go,crawler," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://city.shaform.com/images/2019/cobweb.jpg"/>

<meta name="twitter:title" content="使用 Go 撰寫 Plurk 噗浪偷偷說網路爬蟲"/>
<meta name="twitter:description" content="前言 記得剛開始學習 Go 好像是在 2013 年的時候，不過後來就一直沒太多機會使用。最近剛好想寫個爬蟲，於是就決定用 Go 來練習看看。 這次的目標是 Plurk 噗浪上的「"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-13132274-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</head>
<body>
  
  <div class="header-container" style="background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('https://city.shaform.com/images/background.jpg'); background-position: center; background-size: cover;">
  <div class="container">
  <nav class="header-nav navbar navbar-expand-md navbar-dark light-dark">
    <div class="header-logo navbar-brand">
      
        <a class="float-left" href="https://city.shaform.com/zh/">
      
        
        <img class="mr20 header-logo-image" src="https://city.shaform.com/images/fly.png" alt="logo">
        
        
          翼之都
         
      </a>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="nav-menu collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://city.shaform.com/zh/category/ideas/">點子</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://city.shaform.com/zh/category/notes/">筆記</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://city.shaform.com/zh/category/projects/">專案</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://www.google.com/search?q=site:city.shaform.com">搜尋</a>
              
            
          </li>
        
        
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="https://city.shaform.com/en/"><i class="fas fa-globe"></i> English</a>
            </li>
          
          
        
      </ul>
    </div>
  </nav>
</div>

<div class="container header-wrapper">
  <div class="row">
    <div class="col-lg-12">
      <div class="header-content">
        <h1 class="header-title">使用 Go 撰寫 Plurk 噗浪偷偷說網路爬蟲</h1>
        <p class="header-date">作者：
          Yong-Siang Shih /
        
        Fri 11 January 2019
          / 分類：
          <a href="https://city.shaform.com/zh/category/notes/">Notes</a>
        </p>
        
        <div class="header-underline"></div>
        
          <div class="clearfix"></div>
          <p class="float-right header-tags">
              <i class="fas fa-tags" aria-hidden="true"></i>
              <a href="https://city.shaform.com/zh/tag/plurk/">Plurk</a>, 
                <a href="https://city.shaform.com/zh/tag/crawler/">crawler</a>, 
                <a href="https://city.shaform.com/zh/tag/go/">go</a>
          </p>
        
        

      </div>
    </div>
  </div>
</div>

  </div>
<div class="container content">
  

<h2 id="前言">前言</h2>

<p>記得剛開始學習 Go 好像是在 2013 年的時候，不過後來就一直沒太多機會使用。最近剛好想寫個爬蟲，於是就決定用 Go 來練習看看。</p>

<p>這次的目標是 Plurk 噗浪上的<a href="https://www.plurk.com/anonymous">「偷偷說河道」</a>。</p>

<p>本次的程式放在 <a href="https://github.com/shaform/experiments/tree/master/plurk_crawler">shaform/experiments/plurk_crawler</a>。</p>

<h2 id="環境設定">環境設定</h2>

<p>這次只有用到 <a href="https://github.com/schollz/progressbar">schollz/progressbar</a> 來顯示進度，其他都是使用 Go 內建的函式庫，故只要安裝一個套件：</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">go get -u github.com/schollz/progressbar</span></code></pre></div></div>


<h2 id="撰寫爬蟲">撰寫爬蟲</h2>

<h3 id="分析網頁">分析網頁</h3>

<p>首先透過觀察網路流量的方式分析噗浪的偷偷說到底是讀取什麼資料來顯示的，最後就會發現，主要透過兩組 endpoints。</p>

<p>第一個可以得到偷偷說河道的所有噗：</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">GET /Stats/getAnonymousPlurks?lang=&lt;language&gt;</code></pre></div>
<p>第二個則可以用來讀取一個噗的回應：</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">POST /Responses/get2?plurk_id=&lt;plurk_id&gt;&amp;from_response=&lt;start_num&gt;</code></pre></div>
<p>得知兩組 endpoints 之後就能開始撰寫了。</p>

<h3 id="主程式">主程式</h3>

<p>主程式架構如下所示，首先利用 <code>flag</code> 來宣告參數，主要可以控制語言、存檔資料夾，以及要間隔多久送一次請求，防止被伺服器封鎖。</p>

<p>再來，則是實際呼叫第一個 endpoint 取得偷偷說河道。</p>

<p>最後則是解析河道取得所有的噗，再根據每個噗擷取回應並存檔。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">startUrl</span> <span class="p">=</span> <span class="s">&#34;https://www.plurk.com/Stats/getAnonymousPlurks?lang=%s&#34;</span>

	<span class="c1">// parse args
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">lang</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;lang&#34;</span><span class="p">,</span> <span class="s">&#34;zh&#34;</span><span class="p">,</span> <span class="s">&#34;language of Plurks&#34;</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">outputDir</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;output-dir&#34;</span><span class="p">,</span> <span class="s">&#34;output&#34;</span><span class="p">,</span> <span class="s">&#34;directory for output&#34;</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">file</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;file&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;read file instead of query URL&#34;</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">delay</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="s">&#34;delay&#34;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="s">&#34;delay between each request in milliseconds&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>

	<span class="c1">// get plurks
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">result</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="k">if</span> <span class="o">*</span><span class="nx">file</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">result</span> <span class="p">=</span> <span class="nf">GetPlurksFromFile</span><span class="p">(</span><span class="o">*</span><span class="nx">file</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="nx">startUrl</span><span class="p">,</span> <span class="o">*</span><span class="nx">lang</span><span class="p">)</span>
		<span class="nx">result</span> <span class="p">=</span> <span class="nf">GetPlurks</span><span class="p">(</span><span class="nx">uri</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">plurks</span> <span class="o">:=</span> <span class="nf">ProcessPlurks</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>

	<span class="c1">// start storing content...
</span><span class="c1"></span>	<span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="o">*</span><span class="nx">outputDir</span><span class="p">,</span> <span class="mo">0700</span><span class="p">)</span>
	<span class="nf">FetchAndSavePlurks</span><span class="p">(</span><span class="o">*</span><span class="nx">outputDir</span><span class="p">,</span> <span class="nx">plurks</span><span class="p">,</span> <span class="o">*</span><span class="nx">delay</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<h3 id="讀取噗浪河道">讀取噗浪河道</h3>

<p>使用 HTTP GET 發送請求後，河道的 endpoint 會回傳一組 json 資料，所以我們用 <code>json.Unmarshal</code> 將其解譯成物件。因為 Go 是 static typing，所以不像 Python 那麼方便會根據 json 自動變成各種正確的物件。所以是用 <code>interface{}</code> 來暫時代表任意 <code>type</code> 的物件。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">ParseJson</span><span class="p">(</span><span class="nx">inputs</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">result</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">inputs</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>

<span class="c1">// GetPlurksFromFile queris uri
</span><span class="c1">// to obtain plurk timeline.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">GetPlurks</span><span class="p">(</span><span class="nx">uri</span> <span class="kt">string</span><span class="p">)</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Timeout</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">15</span><span class="p">}</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">uri</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nf">ParseJson</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<h3 id="解析河道內容">解析河道內容</h3>

<p>這裡我們只拿出幾個我們關心的欄位，包含 <code>id</code>、內容、張貼時間、以及有幾個回應等等。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Plurk</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">PlurkId</span>       <span class="kt">int</span>
	<span class="nx">Content</span>       <span class="kt">string</span>
	<span class="nx">Posted</span>        <span class="kt">string</span>
	<span class="nx">ResponseCount</span> <span class="kt">int</span>
	<span class="nx">Responses</span>     <span class="p">[]</span><span class="nx">PlurkResponse</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">PlurkResponse</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Id</span>      <span class="kt">int</span>
	<span class="nx">Handle</span>  <span class="kt">string</span>
	<span class="nx">Content</span> <span class="kt">string</span>
	<span class="nx">Posted</span>  <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// ProcessPlurks parses the timeline,
</span><span class="c1">// and produces a list of plurks.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">ProcessPlurks</span><span class="p">(</span><span class="nx">result</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">[]</span><span class="nx">Plurk</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">plurks</span> <span class="p">[]</span><span class="nx">Plurk</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">result</span> <span class="p">{</span>
		<span class="c1">// Each value is an interface{} type, that is type asserted as a string
</span><span class="c1"></span>		<span class="k">switch</span> <span class="nx">obj</span> <span class="o">:=</span> <span class="nx">value</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}:</span>
			<span class="nx">plurk</span> <span class="o">:=</span> <span class="nx">Plurk</span><span class="p">{</span>
				<span class="nx">PlurkId</span><span class="p">:</span>       <span class="nb">int</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="s">&#34;plurk_id&#34;</span><span class="p">].(</span><span class="kt">float64</span><span class="p">)),</span>
				<span class="nx">Content</span><span class="p">:</span>       <span class="nx">obj</span><span class="p">[</span><span class="s">&#34;content&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">),</span>
				<span class="nx">Posted</span><span class="p">:</span>        <span class="nx">obj</span><span class="p">[</span><span class="s">&#34;posted&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">),</span>
				<span class="nx">ResponseCount</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="s">&#34;response_count&#34;</span><span class="p">].(</span><span class="kt">float64</span><span class="p">))}</span>
			<span class="nx">plurks</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">plurks</span><span class="p">,</span> <span class="nx">plurk</span><span class="p">)</span>
		<span class="k">default</span><span class="p">:</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">plurks</span>
<span class="p">}</span></code></pre></div>
<h3 id="抓取回應">抓取回應</h3>

<p>由於之前已經知道每則噗浪有幾則回應，這裡只要針對有回應的噗浪抓取就行。如果遇到錯誤，可能是該噗浪已經被刪除，所以就把該噗一併捨去。最後再存檔。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// FetchAndSavePlurks queries plurk.com to
</span><span class="c1">// obtain responsese from each plurk and
</span><span class="c1">// save them to disk
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">FetchAndSavePlurks</span><span class="p">(</span><span class="nx">outputDir</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">plurks</span> <span class="p">[]</span><span class="nx">Plurk</span><span class="p">,</span> <span class="nx">delay</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Timeout</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">15</span><span class="p">}</span>
	<span class="nx">bar</span> <span class="o">:=</span> <span class="nx">progressbar</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">plurks</span><span class="p">))</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">plurk</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">plurks</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">responses</span> <span class="p">[]</span><span class="nx">PlurkResponse</span>
		<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
		<span class="k">if</span> <span class="nx">plurk</span><span class="p">.</span><span class="nx">ResponseCount</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">responses</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">FetchResponses</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">client</span><span class="p">,</span> <span class="nx">plurk</span><span class="p">.</span><span class="nx">PlurkId</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[WARN] Responses from %d cannot be fetched\n&#34;</span><span class="p">,</span> <span class="nx">plurk</span><span class="p">.</span><span class="nx">PlurkId</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">plurk</span><span class="p">.</span><span class="nx">Responses</span> <span class="p">=</span> <span class="nx">responses</span>
			<span class="nx">plurkJson</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">plurk</span><span class="p">)</span>
			<span class="nx">ioutil</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s/%d.json&#34;</span><span class="p">,</span> <span class="nx">outputDir</span><span class="p">,</span> <span class="nx">plurk</span><span class="p">.</span><span class="nx">PlurkId</span><span class="p">),</span> <span class="nx">plurkJson</span><span class="p">,</span> <span class="mo">0644</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">bar</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">delay</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">delay</span><span class="p">))</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>至於實際的抓取程式則設計成如下。感覺用 Go 寫起來比 Python 嚴謹不少，在用 Python 時，反正錯誤就習慣讓他丟 Exception 壞掉就算了。可是寫 Go 就強迫要想想錯誤時到底要幹麻。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// FetchResponses fetches responses of a given plurk
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">FetchResponses</span><span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">plurkId</span> <span class="kt">int</span><span class="p">)</span> <span class="p">([]</span><span class="nx">PlurkResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">fetchUrl</span> <span class="p">=</span> <span class="s">&#34;https://www.plurk.com/Responses/get2&#34;</span>

	<span class="nx">data</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">Values</span><span class="p">{}</span>
	<span class="nx">data</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;plurk_id&#34;</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">plurkId</span><span class="p">))</span>
	<span class="nx">data</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;from_response&#34;</span><span class="p">,</span> <span class="s">&#34;0&#34;</span><span class="p">)</span>
	<span class="nx">req</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewRequest</span><span class="p">(</span><span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="nx">fetchUrl</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()))</span>
	<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;X-Requested-With&#34;</span><span class="p">,</span> <span class="s">&#34;XMLHttpRequest&#34;</span><span class="p">)</span>
	<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;application/x-www-form-urlencoded; charset=UTF-8&#34;</span><span class="p">)</span>

	<span class="c1">// fetch responses
</span><span class="c1"></span>	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">!=</span> <span class="mi">200</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">[]</span><span class="nx">PlurkResponse</span><span class="p">{},</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;connot load&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">[]</span><span class="nx">PlurkResponse</span><span class="p">{},</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;connot load&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">result</span> <span class="o">:=</span> <span class="nf">ParseJson</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">responses</span> <span class="p">[]</span><span class="nx">PlurkResponse</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">result</span><span class="p">[</span><span class="s">&#34;responses&#34;</span><span class="p">].([]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="nx">obj</span> <span class="o">:=</span> <span class="nx">value</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}:</span>
			<span class="nx">response</span> <span class="o">:=</span> <span class="nx">PlurkResponse</span><span class="p">{</span>
				<span class="nx">Id</span><span class="p">:</span>      <span class="nb">int</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="s">&#34;id&#34;</span><span class="p">].(</span><span class="kt">float64</span><span class="p">)),</span>
				<span class="nx">Handle</span><span class="p">:</span>  <span class="nx">obj</span><span class="p">[</span><span class="s">&#34;handle&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">),</span>
				<span class="nx">Content</span><span class="p">:</span> <span class="nx">obj</span><span class="p">[</span><span class="s">&#34;content&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">),</span>
				<span class="nx">Posted</span><span class="p">:</span>  <span class="nx">obj</span><span class="p">[</span><span class="s">&#34;posted&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">),</span>
			<span class="p">}</span>
			<span class="nx">responses</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">responses</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
		<span class="k">default</span><span class="p">:</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">responses</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></div>
<p>如此一來就完成了。</p>

<h2 id="實際抓取">實際抓取</h2>

<p>實際抓的時候感覺像這樣：</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">go run crawl.go
</span><span class="m">15</span>% <span class="p">|</span>██████                                  <span class="p">|</span>  <span class="o">[</span>13s:1m11s<span class="o">]</span></code></pre></div></div>


<p>抓完則會像這樣：</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">.                      
├── crawl.go           
└── output             
    ├── 1398664726.json
    ├── ...</code></pre></div>
<p>接著或許就能進行噗浪輿情分析之類等等的運用。</p>

<h2 id="結語">結語</h2>

<p>感覺如果要快速的寫一些 scripts 還是 Python 比較好用，但 Go 寫起來已經算是很快了。本次的程式放在 <a href="https://github.com/shaform/experiments/tree/master/plurk_crawler">shaform/experiments/plurk_crawler</a>。</p>


  
  
    
    <div class="author-card">
    <div class="underline"></div>
    <div class="author-box">
      <div class="author-image"><a href="https://shaform.com"><img src="/images/shaform.jpg" alt="Yong-Siang Shih" /></a></div>
      <div class="author-content">
      <p class="author-title">作者</p>
      <p class="author-name">Yong-Siang Shih</p>
      <p class="author-desc">軟體工程師，機器學習科學家，開放原始碼愛好者。曾在 Appier 從事機器學習系統開發，也曾在 Google, IBM, Microsoft 擔任軟體實習生。喜好探索學習新科技。<br><a href="https://github.com/shaform">* 在 GitHub 上追蹤我</a></p>
      </div>
    </div>
  </div>
    
  
  
<div class="disqus-comment">
<div>
<div class="comment-underline"></div>
</div>
<div class="btn btn-secondary disqus-button" id="load_disqus" onclick="load_disqus()">
  載入 Disqus 評論
</div>
<div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = "https://city.shaform.com/zh/2019/01/11/plurk-crawler/";
  };
  function load_disqus() {
    
    
    if (window.location.hostname === 'localhost') return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'cityofwings';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    dsq.setAttribute('data-timestamp', +new Date());
    (document.head || document.body).appendChild(dsq);

    $('#load_disqus').remove();
  };
</script>
<noscript>Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>

</div>


</div>
<div class="footer gradient-2">
  <div class="container footer-container ">
    <div class="row">
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        <div class="footer-title">網站地圖</div>
        <ul class="list-unstyled">
            
              
                <li><a href="https://city.shaform.com/zh/tags/">標籤</a></li>
              
              
                <li><a href="https://city.shaform.com/zh/categories/">分類</a></li>
              
            
            
            
            <li><a rel="alternate" type="application/rss&#43;xml" href="https://city.shaform.com/zh/index.xml"><i class="fas fa-rss-square"></i> RSS 訂閱</a></li>
            
            
        </ul>
      </div>
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        
        <div class="footer-title">社群</div>
        <ul class="list-unstyled">
          
          <li><a href="https://github.com/shaform/" rel="noopener" target="_blank">GitHub</a></li>
          
        </ul>
        
      </div>
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        
        <div class="footer-title">連結</div>
        <ul class="list-unstyled">
          
          <li><a href="https://shaform.com/" rel="noopener" target="_blank">關於我</a></li>
          
          <li><a href="https://island.shaform.com/" rel="noopener" target="_blank">一座島</a></li>
          
        </ul>
        
      </div> 
      <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
        <p class="pull-right text-right">
          <small><em>Proudly powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo</a></em></small><br/>
          <small><em>Theme - <a href="https://github.com/shaform/hugo-theme-den" rel="noopener" target="_blank">Den</a></em></small><br/>
          <small>
            &copy; 
            Shaform
            
              2010 -
            2019
          </small>
          
        </p>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script>
$(document).ready(function() {
  if ($('#load_disqus').length) {
    $(window).scroll(function() {
      if ($('#load_disqus').length) {
        var elementTop = $('#load_disqus').offset().top;
        var viewportTop = $(window).scrollTop();
        var viewportBottom = viewportTop + $(window).height();
        if (viewportTop < elementTop && elementTop < viewportBottom) {
          load_disqus();
        }
      }
    });
  }
});
</script>

</body>
</html>
