<!DOCTYPE html>
<html lang="zh" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta name="generator" content="Hugo 0.49.1" />
  <meta charset="utf-8">
  <title>Scrapy Cloud &#43; Scrapy 網路爬蟲 · 翼之都</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="前言：取得研究資料集 最近聽到不少擅長 Deep Learning 的朋友買了顯示卡準備自己做起研究，讓人也十分受到激勵。不過平常想自己做研究時，常常會因為沒有適當的資" />

  <meta name="keywords" content="Shaform, open source, Python, machine learning, software" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
<link rel="stylesheet" href="https://city.shaform.com/css/den.css">




<meta property="og:title" content="Scrapy Cloud &#43; Scrapy 網路爬蟲" />
<meta property="og:description" content="前言：取得研究資料集 最近聽到不少擅長 Deep Learning 的朋友買了顯示卡準備自己做起研究，讓人也十分受到激勵。不過平常想自己做研究時，常常會因為沒有適當的資" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://city.shaform.com/zh/2017/05/13/scrapy-cloud/" /><meta property="article:published_time" content="2017-05-13T16:10:00&#43;08:00"/>
<meta property="article:modified_time" content="2017-05-13T16:10:00&#43;08:00"/>

<meta itemprop="name" content="Scrapy Cloud &#43; Scrapy 網路爬蟲">
<meta itemprop="description" content="前言：取得研究資料集 最近聽到不少擅長 Deep Learning 的朋友買了顯示卡準備自己做起研究，讓人也十分受到激勵。不過平常想自己做研究時，常常會因為沒有適當的資">


<meta itemprop="datePublished" content="2017-05-13T16:10:00&#43;08:00" />
<meta itemprop="dateModified" content="2017-05-13T16:10:00&#43;08:00" />
<meta itemprop="wordCount" content="3541">



<meta itemprop="keywords" content="Scrapy Cloud,Scrapy,PTT,Python 3," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Scrapy Cloud &#43; Scrapy 網路爬蟲"/>
<meta name="twitter:description" content="前言：取得研究資料集 最近聽到不少擅長 Deep Learning 的朋友買了顯示卡準備自己做起研究，讓人也十分受到激勵。不過平常想自己做研究時，常常會因為沒有適當的資"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-13132274-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</head>
<body>
  
  <div class="header-container" style="background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('https://city.shaform.com/images/background.jpg'); background-position: center; background-size: cover;">
  <div class="container">
  <nav class="header-nav navbar navbar-expand-md navbar-dark light-dark">
    <div class="header-logo navbar-brand">
      
        <a class="float-left" href="https://city.shaform.com/zh/">
      
        
        <img class="mr20 header-logo-image" src="https://city.shaform.com/images/fly.png" alt="logo">
        
        
          翼之都
         
      </a>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="nav-menu collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://city.shaform.com/zh/category/ideas/">點子</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://city.shaform.com/zh/category/notes/">筆記</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://city.shaform.com/zh/category/projects/">專案</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://www.google.com/search?q=site:city.shaform.com">搜尋</a>
              
            
          </li>
        
        
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="https://city.shaform.com/en/"><i class="fas fa-globe"></i> English</a>
            </li>
          
          
        
      </ul>
    </div>
  </nav>
</div>

<div class="container header-wrapper">
  <div class="row">
    <div class="col-lg-12">
      <div class="header-content">
        <h1 class="header-title">Scrapy Cloud &#43; Scrapy 網路爬蟲</h1>
        <p class="header-date">作者：
          Shaform /
        
        Sat 13 May 2017
          / 分類：
          <a href="https://city.shaform.com/zh/category/notes/">Notes</a>
        </p>
        
        <div class="header-underline"></div>
        
          <div class="clearfix"></div>
          <p class="float-right header-tags">
              <i class="fas fa-tags" aria-hidden="true"></i>
              <a href="https://city.shaform.com/zh/tag/ptt/">PTT</a>, 
                <a href="https://city.shaform.com/zh/tag/python-3/">Python 3</a>, 
                <a href="https://city.shaform.com/zh/tag/scrapy/">Scrapy</a>, 
                <a href="https://city.shaform.com/zh/tag/scrapy-cloud/">Scrapy Cloud</a>
          </p>
        
        

      </div>
    </div>
  </div>
</div>

  </div>
<div class="container content">
  

<h2 id="前言-取得研究資料集">前言：取得研究資料集</h2>

<p>最近聽到不少擅長 Deep Learning 的朋友買了<a href="https://www.nvidia.com/en-us/geforce/products/10series/geforce-gtx-1080-ti/">顯示卡</a>準備自己做起研究，讓人也十分受到激勵。不過平常想自己做研究時，常常會因為沒有適當的資料集而窒礙難行。尤其不少學術資料集似乎需要由研究單位出面才能取得，使得默默無名的個人研究者深感惶恐，此時撰寫網路爬蟲蒐集資料便成為必要的麻煩。無怪乎本站的<a href="/zh/2016/02/28/scrapy/">〈Scrapy 筆記〉</a>似乎也一直很熱門。</p>

<p>只是平常在學校有龐大學術網路資源的支持，撰寫爬蟲還算可行。但自己一個人寫爬蟲就很辛苦了。總會擔心 IP 被阻擋要怎麼辦，還有電腦開太久，到處亂爬，會不會因此被駭客攻擊等問題。</p>

<p>就在最近，得知有 <a href="https://scrapinghub.com/scrapy-cloud/">Scrapy Cloud</a> 這樣方便的服務，可以用來架設自己的爬蟲，感覺相當方便。於是本文就以 <a href="https://www.ptt.cc/bbs/Beauty/index.html">PTT Beauty 板</a> 為範例，紀錄利用 Scrapy Cloud 撰寫爬蟲的過程。</p>

<h2 id="環境設置">環境設置</h2>

<p>這次同樣使用 <a href="https://docs.python.org/3/library/venv.html">pyvenv</a> 創立虛擬環境，好安裝自己的 Python 套件：</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">pyvenv-3.5 env
</span><span class="hl"><span class="nb">source</span> env/bin/activate
</span><span class="hl">pip install -U pip</span></code></pre></div></div>


<p>此外，也安裝 <a href="https://scrapy.org/">Scrapy</a>，以及本次實驗會用到的加密套件等等。</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">pip install <span class="nv">Scrapy</span><span class="o">==</span><span class="m">1</span>.3.3 <span class="nv">cryptography</span><span class="o">==</span><span class="m">1</span>.8.1 <span class="nv">html2text</span><span class="o">==</span><span class="m">2016</span>.5.29</span></code></pre></div></div>


<h3 id="scrapy-cloud">Scrapy Cloud</h3>

<p>Scrapy Cloud 其實就是 <a href="https://scrapy.org/">Scrapy</a> 背後的公司 <a href="https://scrapinghub.com/">Scrapinghub</a> 所推出的線上爬蟲服務。可以把自己寫好的爬蟲上傳到遠端的機器執行。由於 IP 偶爾就會換一次，所以可以大幅降低被阻擋的風險。在筆者撰文的當下，每個人的帳號都有一個免費的 slot (1 GB RAM) 可以用來跑爬蟲，爬下來的資料可供存放一個星期，個人使用已經相當足夠了。如果有更高的需求，也可用 $9/month 的價格購買多的 slots，或者購買可以每個 request 都使用不同 IP，大幅降低被阻擋風險的強大 proxy 服務。</p>

<p>創建完帳號後，首先可以在 <a href="https://app.scrapinghub.com/account/apikey">API Key</a> 頁面取得自己的 <code>SH_APIKEY</code>，到時上傳爬蟲時會用到。然後可以建立一個 project，並在 project 網址裡取得 <code>SHUB_PROJECT_ID</code>:</p>

<pre><code>https://app.scrapinghub.com/p/&lt;SHUB_PROJECT_ID&gt;/jobs
</code></pre>

<p>最後也安裝專用的 <a href="https://github.com/scrapinghub/shub">shub</a> 部署工具。</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">pip install shub</span></code></pre></div></div>


<h3 id="backblaze-b2-cloud-storage">Backblaze B2 Cloud Storage</h3>

<p>Scrapy Cloud 雖然方便，不過並不支援像圖片一般大檔案的儲存。平常在學術或者企業的研究單位裡，可能有類似 <a href="https://aws.amazon.com/s3/">S3</a> 之類的儲存方案。不過一般小資女，小資男等等可能就沒有辦法負擔了。<a href="https://www.backblaze.com/b2/cloud-storage.html">Backblaze B2 Cloud Storage</a> 在筆者撰文的當下，有著 $0.005/GB/month 的低廉價格，而且上傳免費，又有 10 GB 的免費空間，而且如果只是要使用免費的部份，也不用提供付款資料，不怕被亂收錢。對於個人爬蟲的應用來說，已經相當足夠了。</p>

<p>註冊以後，可以在 <a href="https://secure.backblaze.com/b2_buckets.htm">Buckets</a> 頁面取得 Account ID 以及 Application Key，以下稱為 <code>B2_ACCOUNT_ID</code> 以及 <code>B2_APPLICATION_KEY</code>，此外同時也可以創立一個 bucket 來存放檔案，以下就把這個 bucket 稱作 <code>storage-ptt-beauty</code>。</p>

<p>最後可以安裝 <a href="https://github.com/Backblaze/B2_Command_Line_Tool">b2</a> 套件，測試檔案的操作。</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">pip install b2</span></code></pre></div></div>


<h2 id="撰寫爬蟲">撰寫爬蟲</h2>

<p>於是就開始撰寫爬蟲！</p>

<p>首先創立專案：</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">scrapy startproject ptt_beauty</span></code></pre></div></div>


<p>啟用自動連線延遲：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/settings.py</span>
<span class="n">AUTOTHROTTLE_ENABLED</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">AUTOTHROTTLE_START_DELAY</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">AUTOTHROTTLE_MAX_DELAY</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">AUTOTHROTTLE_TARGET_CONCURRENCY</span> <span class="o">=</span> <span class="mf">1.0</span></code></pre></div>
<p>像上次一樣定義一些想要抓取的項目，包含本文和推文等等，但多增加檔案的欄位 <code>files</code> 和 <code>file_urls</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/items.py</span>
<span class="k">class</span> <span class="nc">PostItem</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">date</span> <span class="s1">&#39;= scrapy.Field:()&#39;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">file_urls</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span></code></pre></div>
<p>接著創立爬蟲：</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">scrapy genspider beauty_images ptt.cc</span></code></pre></div></div>


<p>接著就編輯 <code>&lt;root_dir&gt;/ptt_beauty/spiders/beauty_images.py</code> 實際撰寫爬蟲程式了。</p>

<p>有了上次的經驗，這次寫起來相當順利。首先設定起始的網址：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/spiders/beauty_images.py</span>
<span class="kn">import</span> <span class="nn">scrapy</span>


<span class="k">class</span> <span class="nc">BeautyImagesSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;beauty_images&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ptt.cc&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;https://www.ptt.cc/bbs/Beauty/index.html&#39;</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_pages</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_pages</span> <span class="o">=</span> <span class="n">max_pages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">=</span> <span class="mi">0</span></code></pre></div>
<p>然後照抄以前的程式，不過移除 18 歲的部份：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/spiders/beauty_images.py</span>
<span class="kn">from</span> <span class="nn">ptt_beauty.items</span> <span class="kn">import</span> <span class="n">PostItem</span>


<span class="k">class</span> <span class="nc">BeautyImagesSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">href</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;.r-ent &gt; div.title &gt; a::attr(href)&#39;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">href</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
            <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_post</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_pages</span><span class="p">:</span>
            <span class="n">next_page</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
                <span class="s1">&#39;//div[@id=&#34;action-bar-container&#34;]//a[contains(text(), &#34;上頁&#34;)]/@href&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">next_page</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">next_page</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;follow {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
                <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;no next page&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;max pages reached&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">PostItem</span><span class="p">()</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
            <span class="s1">&#39;//meta[@property=&#34;og:title&#34;]/@content&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
            <span class="s1">&#39;//div[@class=&#34;article-metaline&#34;]/span[text()=&#34;作者&#34;]/following-sibling::span[1]/text()&#39;</span><span class="p">)[</span>
                <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">datetime_str</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
            <span class="s1">&#39;//div[@class=&#34;article-metaline&#34;]/span[text()=&#34;時間&#34;]/following-sibling::span[1]/text()&#39;</span><span class="p">)[</span>
                <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">,</span> <span class="s1">&#39;%a %b </span><span class="si">%d</span><span class="s1"> %H:%M:%S %Y&#39;</span><span class="p">)</span>

        <span class="n">converter</span> <span class="o">=</span> <span class="n">html2text</span><span class="o">.</span><span class="n">HTML2Text</span><span class="p">()</span>
        <span class="n">converter</span><span class="o">.</span><span class="n">ignore_links</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
            <span class="s1">&#39;//div[@id=&#34;main-content&#34;]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>

        <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[@class=&#34;push&#34;]&#39;</span><span class="p">):</span>
            <span class="n">push_tag</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;span.push-tag::text&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
            <span class="n">push_user</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;span.push-userid::text&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
            <span class="n">push_content</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;span.push-content::text&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;推&#39;</span> <span class="ow">in</span> <span class="n">push_tag</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="s1">&#39;噓&#39;</span> <span class="ow">in</span> <span class="n">push_tag</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">total_score</span> <span class="o">+=</span> <span class="n">score</span>

            <span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">push_user</span><span class="p">,</span>
                             <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">push_content</span><span class="p">,</span>
                             <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">})</span>

        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comments</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_score</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span>

        <span class="k">yield</span> <span class="n">item</span></code></pre></div>
<p>在 <code>&lt;root_dir&gt;</code> 根目錄（有 <code>scrapy.cfg</code> 的目錄）執行：</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">scrapy crawl beauty_images -o test.jl</span></code></pre></div></div>


<p>測試確實可以抓到文章。</p>

<h2 id="抓取圖片">抓取圖片</h2>

<p>由於我們實際上只想要抓有圖片的文章，所以將程式改寫。同時為了方便起見，只抓 <code>imgur.com</code> 上的 <code>.jpg</code> 圖片。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/spiders/beauty_images.py</span>
<span class="k">class</span> <span class="nc">BeautyImagesSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">parse_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="c1"># ...</span>
        <span class="n">file_urls</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
            <span class="s1">&#39;//a[contains(@href, &#34;imgur.com&#34;)]/@href&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">file_urls</span><span class="p">:</span>
            <span class="n">file_urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">file_urls</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.jpg&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">file_urls</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;file_urls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_urls</span>

            <span class="k">yield</span> <span class="n">item</span></code></pre></div>
<p>然後先按照 <a href="https://doc.scrapy.org/en/latest/topics/media-pipeline.html">Downloading and processing files and images</a> 的教學啟用 Files Pipeline 做測試：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/spiders/beauty_images.py</span>
<span class="n">ITEM_PIPELINES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s1">&#39;scrapy.pipelines.files.FilesPipeline&#39;</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="n">FILES_STORE</span> <span class="o">=</span> <span class="s1">&#39;images&#39;</span></code></pre></div>
<p>再次在 <code>&lt;root_dir&gt;</code> 根目錄（有 <code>scrapy.cfg</code> 的目錄）執行：</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">scrapy crawl beauty_images -o test.jl</span></code></pre></div></div>


<p>應該會看到在 <code>&lt;root_dir&gt;/images/full/</code> 底下出現不少圖片。</p>

<p>假設只是要在本機上抓圖，這樣就行了，不過我們想在 Scrapy Cloud 上，把圖傳到 B2 空間，因此還得進行一些修改。</p>

<h2 id="上傳-b2">上傳 B2</h2>

<p>首先寫好上傳的串接程式，這裡因為我主要是想抓圖，所以如果 B2 連不上就乾脆用 <code>CloseSpider</code> 把整個爬蟲關掉了。同時因為上傳不用用錢，獲取檔案資訊卻有限制，所以乾脆 <code>stat_file</code> 就讓他永遠回傳空的，反正遇到相同檔案就重新上傳就好。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/spiders/pipelines.py</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">b2.api</span> <span class="kn">import</span> <span class="n">B2Api</span>
<span class="kn">from</span> <span class="nn">b2.upload_source</span> <span class="kn">import</span> <span class="n">UploadSourceBytes</span>

<span class="kn">from</span> <span class="nn">scrapy.exceptions</span> <span class="kn">import</span> <span class="n">CloseSpider</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">B2FilesStore</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">B2_ACCOUNT_ID</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">B2_APPLICATION_KEY</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;b2://&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">uri</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">B2Api</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">authorize_account</span><span class="p">(</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B2_ACCOUNT_ID</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">B2_APPLICATION_KEY</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_b2_bucket</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">CloseSpider</span><span class="p">(</span><span class="s1">&#39;could not initialize B2&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stat_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_get_b2_bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_bucket_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">UploadSourceBytes</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">persist_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s2">&#34;&#34;&#34;Upload file to B2 storage&#34;&#34;&#34;</span>
        <span class="n">key_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">threads</span><span class="o">.</span><span class="n">deferToThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_upload_file</span><span class="p">,</span>
                                     <span class="n">buf</span><span class="o">=</span><span class="n">buf</span><span class="p">,</span>
                                     <span class="n">file_name</span><span class="o">=</span><span class="n">key_name</span><span class="p">)</span></code></pre></div>
<p>緊接著我們修改原本 scrapy 的 <a href="https://github.com/scrapy/scrapy/blob/1.3/scrapy/pipelines/files.py">FilesPipeline</a> 變成 <code>EncryptedFilesPipeline</code>。目的是為了讓他支援加密以及我們的 <code>B2FilesStore</code>。</p>

<p>之所以要加密的原因是為了怕鄉民上傳一些奇怪的圖片導致我們抓到怪圖上傳，可能造成停權之類的奇怪後果。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/spiders/pipelines.py</span>
<span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>

<span class="kn">from</span> <span class="nn">scrapy.pipelines.files</span> <span class="kn">import</span> <span class="n">FilesPipeline</span>
<span class="kn">from</span> <span class="nn">scrapy.utils.misc</span> <span class="kn">import</span> <span class="n">load_object</span>


<span class="k">class</span> <span class="nc">EncryptedFilesPipeline</span><span class="p">(</span><span class="n">FilesPipeline</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">store_uri</span><span class="p">,</span> <span class="n">download_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">store_uri</span><span class="p">,</span>
                         <span class="n">download_func</span><span class="o">=</span><span class="n">download_func</span><span class="p">,</span>
                         <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

        <span class="n">cls_name</span> <span class="o">=</span> <span class="s2">&#34;EncryptedFilesPipeline&#34;</span>
        <span class="n">resolve</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_key_for_pipe</span><span class="p">,</span>
                                    <span class="n">base_class_name</span><span class="o">=</span><span class="n">cls_name</span><span class="p">,</span>
                                    <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

        <span class="n">encryption_key</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resolve</span><span class="p">(</span><span class="s1">&#39;FILES_ENCRYPTION_KEY&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">encryption_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">encryption_key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_settings</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">STORE_SCHEMES</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_load_components</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;FILES_STORES&#39;</span><span class="p">)</span>
        <span class="n">b2store</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">STORE_SCHEMES</span><span class="p">[</span><span class="s1">&#39;b2&#39;</span><span class="p">]</span>
        <span class="n">b2store</span><span class="o">.</span><span class="n">B2_ACCOUNT_ID</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;B2_ACCOUNT_ID&#39;</span><span class="p">]</span>
        <span class="n">b2store</span><span class="o">.</span><span class="n">B2_APPLICATION_KEY</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;B2_APPLICATION_KEY&#39;</span><span class="p">]</span>
        <span class="n">store_uri</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;FILES_STORE&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">store_uri</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_load_components</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">setting_prefix</span><span class="p">):</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">without_none_values</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">getwithbase</span><span class="p">(</span><span class="n">setting_prefix</span><span class="p">))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_object</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">NotConfigured</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">file_downloaded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">checksum</span> <span class="o">=</span> <span class="n">md5sum</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">persist_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">checksum</span></code></pre></div>
<p>接下來可以在 <code>&lt;root_dir&gt;/ptt_beauty/settings.py</code> 填入以下設定：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/settings.py</span>
<span class="n">ITEM_PIPELINES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ptt_beauty.pipelines.EncryptedFilesPipeline&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="n">FILES_STORES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="s1">&#39;scrapy.pipelines.files.FSFilesStore&#39;</span><span class="p">,</span>
    <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="s1">&#39;scrapy.pipelines.files.FSFilesStore&#39;</span><span class="p">,</span>
    <span class="s1">&#39;s3&#39;</span><span class="p">:</span> <span class="s1">&#39;scrapy.pipelines.files.S3FilesStore&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b2&#39;</span><span class="p">:</span> <span class="s1">&#39;ptt_beauty.pipelines.B2FilesStore&#39;</span><span class="p">,</span>
<span class="p">}</span></code></pre></div>
<p>然後填入對應的密鑰做測試，不過測試完這些設定還是不要直接寫在檔案裡比較好。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/settings.py</span>
<span class="n">FILES_ENCRYPTION_KEY</span> <span class="o">=</span> <span class="s1">&#39;&lt;YOUR_ENCRYPT_KEY&gt;&#39;</span>
<span class="n">FILES_STORE</span> <span class="o">=</span> <span class="s1">&#39;b2://storage-ptt-beauty/ptt-beauty/images/&#39;</span>
<span class="n">B2_ACCOUNT_ID</span> <span class="o">=</span> <span class="s1">&#39;&lt;B2_ACCOUNT_ID&gt;&#39;</span>
<span class="n">B2_APPLICATION_KEY</span> <span class="o">=</span> <span class="s1">&#39;&lt;B2_APPLICATION_KEY&gt;&#39;</span></code></pre></div>
<p>其中 <code>storage-ptt-beauty</code> 是在 B2 上創建的 bucket 名稱，後面的 <code>ptt-beauty/images/</code> 則是自行指定要存放圖片的根目錄。</p>

<p>而檔案加密的密鑰 <code>YOUR_ENCRYPT_KEY</code> 可以這樣產生：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>


<span class="n">Fernet</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span></code></pre></div>
<p>加密完的檔案可以這樣解密：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>


<span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="s1">&#39;&lt;YOUR_ENCRYPT_KEY&gt;&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;&lt;INPUT_PATH&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;&lt;OUTPUT_PATH&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span></code></pre></div>
<p>再次在 <code>&lt;root_dir&gt;</code> 根目錄（有 <code>scrapy.cfg</code> 的目錄）執行：</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">scrapy crawl beauty_images -o test.jl</span></code></pre></div></div>


<p>應該會看到在 B2 裡出現不少加密檔案。</p>

<h2 id="部署到-scrapy-cloud">部署到 Scrapy Cloud</h2>

<p>最後的部署，首先新增相依檔案 <code>requirements.txt</code>：</p>

<pre><code>b2==0.7.2
cryptography==1.8.1
html2text==2016.5.29
</code></pre>

<p>再新增設定檔 <code>scrapinghub.yml</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-yml" data-lang="yml">projects<span class="p">:</span><span class="w">
</span><span class="w">  </span>default<span class="p">:</span><span class="w"> </span>&lt;PROjECT_ID<span class="sd">&gt;
</span><span class="sd">stacks:
</span><span class="sd">    default: scrapy:1.3-py3
</span><span class="sd">requirements_file: requirements.txt</span></code></pre></div>
<p>接著將整個資料夾的相關程式碼和設定檔都 commit 到 git repository 裡。然後在該資料夾執行：</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">shub login
</span><span class="hl">shub deploy</span></code></pre></div></div>


<p>輸入相應的 <code>SH_APIKEY</code> 即可上傳。</p>

<p>最後則在 project 的 spiders settings <code>https://app.scrapinghub.com/p/&lt;SHUB_PROJECT_ID&gt;/job-settings/standard</code> 裡，把各種密鑰輸進去：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">FILES_ENCRYPTION_KEY</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span>
<span class="n">FILES_STORE</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span>
<span class="n">B2_ACCOUNT_ID</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span>
<span class="n">B2_APPLICATION_KEY</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span></code></pre></div>
<p>如此就行了！可在 Dashboard 執行上傳的爬蟲。</p>

<h2 id="定期上傳抓取文章到-b2">定期上傳抓取文章到 B2</h2>

<p>Scrapy Cloud 也支援排程執行，所以可以每天都到板上抓圖。然而雖然做完以上步驟就會把下載的圖片上傳到 B2，可是抓取的文章還是在 Scrapy Cloud 裡頭。幸好 Scrapy Cloud 也提供定期執行自訂 script 的功能。所以我們也可以另外寫個程式把抓好的文章上傳到 B2 上。</p>

<p>由於 script 不像 spider 會自動讀取 project settings，我們先自行寫一個讀取的函式，這樣就可以在 script 裡讀取在 Scrapy Cloud 上設定的參數：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/utils.py</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">scrapy.utils.project</span> <span class="kn">import</span> <span class="n">get_project_settings</span>


<span class="k">def</span> <span class="nf">get_shub_project_settings</span><span class="p">():</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_project_settings</span><span class="p">()</span>
    <span class="n">shub_settings</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SHUB_SETTINGS&#39;</span><span class="p">,</span> <span class="s1">&#39;{}&#39;</span><span class="p">))</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">setdict</span><span class="p">(</span>
        <span class="n">shub_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project_settings&#39;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;project&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">settings</span></code></pre></div>
<p>除此之外也順便新增一些方便處理 B2 上傳的函式：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/utils.py</span>

<span class="kn">from</span> <span class="nn">b2.upload_source</span> <span class="kn">import</span> <span class="n">UploadSourceBytes</span>

<span class="k">def</span> <span class="nf">split_bucket_prefix</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">uri</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">UploadSourceBytes</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">bucket</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span></code></pre></div>
<p>最後就可以實際實做抓取資料的程式了，首先定義執行參數。</p>

<p>新增的 project settings 包含：</p>

<ul>
<li><code>&lt;SH_APIKEY&gt;</code>: 就是之前提到的 Scrapy Cloud 的 API Key</li>
<li><code>&lt;SHUB_PROJECT_ID&gt;</code>: 本次部屬到 Scrapy Cloud 的 project ID</li>
<li><code>&lt;ITEMS_STORE&gt;</code>: 儲存文章的地點，例如 <code>b2://storage-ptt-beauty/ptt-beauty/items/</code></li>
</ul>

<p>同樣在 project 的 spiders settings <code>https://app.scrapinghub.com/p/&lt;SHUB_PROJECT_ID&gt;/job-settings/standard</code> 裡，把他們輸進去。</p>

<p>另外可以指定要抓取的 spider 名稱，以本例來說，只有 <code>beauty_images</code> 一種。<code>--delete</code> 參數則是指定抓取完後，是否要把 Scrapy Cloud 上對應的 job 順便刪除，以免下次重複上傳。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/bin/upload_items.py</span>

<span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">from</span> <span class="nn">ptt_beauty.utils</span> <span class="kn">import</span> <span class="n">get_shub_project_settings</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_shub_project_settings</span><span class="p">()</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--api-key&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SH_APIKEY&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--project-id&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SHUB_PROJECT_ID&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--b2-account-id&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;B2_ACCOUNT_ID&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--b2-application-key&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;B2_APPLICATION_KEY&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--b2-path&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ITEMS_STORE&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--delete&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;spider_name&#39;</span><span class="p">,</span>
                        <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Spider name to get info from.&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">args</span><span class="o">.</span><span class="n">b2_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;b2://&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">args</span>


<span class="k">if</span> <span class="s1">&#39;__main__&#39;</span> <span class="o">==</span> <span class="vm">__name__</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">parse_args</span><span class="p">()))</span></code></pre></div>
<p>最後則是主程式，先用 <code>ScrapinghubClient</code> 列出需要處理的 jobs。</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/bin/upload_items.py</span>

<span class="kn">from</span> <span class="nn">scrapinghub</span> <span class="kn">import</span> <span class="n">ScrapinghubClient</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">spider_name</span><span class="p">,</span> <span class="n">b2_account_id</span><span class="p">,</span> <span class="n">b2_application_key</span><span class="p">,</span>
         <span class="n">b2_path</span><span class="p">,</span> <span class="n">delete</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">ScrapinghubClient</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_project</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">spider_name</span><span class="p">:</span>
        <span class="n">spider</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">spiders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">job_list</span> <span class="o">=</span> <span class="n">spider</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="nb">list</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;finished&#39;</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;items&#39;</span> <span class="ow">in</span> <span class="n">job</span> <span class="ow">and</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;items&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span></code></pre></div>
<p>緊接著，把下載的文章用 gzip 壓縮後，上傳到指定的位置上，並順便刪除上傳完的 jobs：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/bin/upload_items.py</span>

<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">b2.api</span> <span class="kn">import</span> <span class="n">B2Api</span>
<span class="kn">from</span> <span class="nn">ptt_beauty.utils</span> <span class="kn">import</span> <span class="n">split_bucket_prefix</span>
<span class="kn">from</span> <span class="nn">ptt_beauty.utils</span> <span class="kn">import</span> <span class="n">upload_file</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">spider_name</span><span class="p">,</span> <span class="n">b2_account_id</span><span class="p">,</span> <span class="n">b2_application_key</span><span class="p">,</span>
         <span class="n">b2_path</span><span class="p">,</span> <span class="n">delete</span><span class="p">):</span>
    <span class="n">bucket_name</span><span class="p">,</span> <span class="n">root</span> <span class="o">=</span> <span class="n">split_bucket_prefix</span><span class="p">(</span><span class="n">b2_path</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">spider_name</span><span class="p">:</span>
        <span class="c1"># ...</span>

        <span class="k">if</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bucket</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">b2_api</span> <span class="o">=</span> <span class="n">B2Api</span><span class="p">()</span>
                <span class="n">b2_api</span><span class="o">.</span><span class="n">authorize_account</span><span class="p">(</span><span class="s1">&#39;production&#39;</span><span class="p">,</span> <span class="n">b2_account_id</span><span class="p">,</span>
                                         <span class="n">b2_application_key</span><span class="p">)</span>
                <span class="n">bucket</span> <span class="o">=</span> <span class="n">b2_api</span><span class="o">.</span><span class="n">get_bucket_by_name</span><span class="p">(</span><span class="n">bucket_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">spider</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>

                    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="nb">iter</span><span class="p">():</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                            <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                             <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.jl.gz&#39;</span><span class="p">)</span>
                    <span class="n">upload_file</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;job {} deleted&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span></code></pre></div>
<p>然後在 <code>setup.py</code> 新增 script 的位置 <code>bin/upload_items.py</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt_beauty/setup.py</span>
<span class="c1"># Automatically created by: shub deploy</span>

<span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span>         <span class="o">=</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span>
    <span class="n">version</span>      <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
    <span class="n">packages</span>     <span class="o">=</span> <span class="n">find_packages</span><span class="p">(),</span>
    <span class="n">scripts</span>      <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bin/upload_items.py&#39;</span><span class="p">],</span>
    <span class="n">entry_points</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scrapy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;settings = ptt_beauty.settings&#39;</span><span class="p">]},</span>
<span class="p">)</span></code></pre></div>
<p>新增相依檔案 <code>requirements.txt</code> 中的一行：</p>

<pre><code>scrapinghub==2.0.0
</code></pre>

<p>緊接著上傳更新的程式：</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">shub deploy</span></code></pre></div></div>


<p>最後就能在 Dashboard 上執行 script 了，記得在 Arguments 欄位填上 <code>beauty_images</code> 等參數。</p>

<p><img src="/images/upload_items.png" alt="upload_items.py" /></p>

<h2 id="結語">結語</h2>

<p>如此一來就能順利的每天抓文章和圖了，其他像是偵測不要抓到同樣的文章等等的功能就請各位自行研究了。</p>

<p>這次實驗所用到的程式碼按照慣例放在 GitHub 上面供參考：<a href="https://github.com/shaform/ptt-beauty">https://github.com/shaform/ptt-beauty</a>。</p>


  
  
<div class="disqus-comment">
<div>
<div class="comment-underline"></div>
</div>
<div class="btn btn-secondary disqus-button" id="load_disqus" onclick="load_disqus()">
  載入 Disqus 評論
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_config = function () {
    this.page.url = "https://city.shaform.com/zh/2017/05/13/scrapy-cloud/";
  };
  function load_disqus() {
    
    
    if (window.location.hostname === 'localhost') return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'cityofwings';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    dsq.setAttribute('data-timestamp', +new Date());
    (document.head || document.body).appendChild(dsq);

    $('#load_disqus').remove();
  };
</script>
<noscript>Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>

</div>


</div>
<div class="footer gradient-2">
  <div class="container footer-container ">
    <div class="row">
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        <div class="footer-title">網站地圖</div>
        <ul class="list-unstyled">
            
              
                <li><a href="https://city.shaform.com/zh/tags/">標籤</a></li>
              
              
                <li><a href="https://city.shaform.com/zh/categories/">分類</a></li>
              
            
            
            
            <li><a rel="alternate" type="application/rss&#43;xml" href="https://city.shaform.com/zh/index.xml"><i class="fas fa-rss-square"></i> RSS 訂閱</a></li>
            
            
        </ul>
      </div>
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        
        <div class="footer-title">社群</div>
        <ul class="list-unstyled">
          
          <li><a href="https://github.com/shaform/" rel="noopener" target="_blank">GitHub</a></li>
          
        </ul>
        
      </div>
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        
        <div class="footer-title">連結</div>
        <ul class="list-unstyled">
          
          <li><a href="https://shaform.com/" rel="noopener" target="_blank">關於我</a></li>
          
          <li><a href="https://island.shaform.com/" rel="noopener" target="_blank">一座島</a></li>
          
        </ul>
        
      </div> 
      <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
        <p class="pull-right text-right">
          <small><em>Proudly powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo</a></em></small><br/>
          <small><em>Theme - <a href="https://github.com/shaform/hugo-theme-den" rel="noopener" target="_blank">Den</a></em></small><br/>
          <small>
            &copy; 
            Shaform
            
              2010 -
            2018
          </small>
          
        </p>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

</body>
</html>
