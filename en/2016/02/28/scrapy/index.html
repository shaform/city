<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta name="generator" content="Hugo 0.53" />
  <meta charset="utf-8">
  <title>Scrapy &#43; Python 3: PTT Data Scraping and Analysis · City of Wings</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Scrapy 1.1 with Python 3 Support Long long time ago, I wanted to learn about web crawling to scrape some data from the PTT forum to see what could be done with it. I found the Scrapy framework, and felt it had great potential. But it didn&amp;rsquo;t support Python 3 at that time, so I&amp;rsquo;ve decided to wait. Now, Scrapy 1.1 is released. Along with updated features, it also has" />

  <meta name="keywords" content="Shaform, open source, Python, machine learning, software" /><link rel="icon" href="https://city.shaform.com/favicon.ico" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
<link rel="stylesheet" href="https://city.shaform.com/css/den.css">




<meta property="og:title" content="Scrapy &#43; Python 3: PTT Data Scraping and Analysis" />
<meta property="og:description" content="Scrapy 1.1 with Python 3 Support Long long time ago, I wanted to learn about web crawling to scrape some data from the PTT forum to see what could be done with it. I found the Scrapy framework, and felt it had great potential. But it didn&rsquo;t support Python 3 at that time, so I&rsquo;ve decided to wait. Now, Scrapy 1.1 is released. Along with updated features, it also has" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://city.shaform.com/en/2016/02/28/scrapy/" />
<meta property="og:image" content="https://city.shaform.com/images/2019/cobweb.jpg" />
<meta property="article:published_time" content="2016-02-28T10:23:00&#43;08:00"/>
<meta property="article:modified_time" content="2016-02-28T10:23:00&#43;08:00"/><meta property="og:site_name" content="City of Wings" />

<meta itemprop="name" content="Scrapy &#43; Python 3: PTT Data Scraping and Analysis">
<meta itemprop="description" content="Scrapy 1.1 with Python 3 Support Long long time ago, I wanted to learn about web crawling to scrape some data from the PTT forum to see what could be done with it. I found the Scrapy framework, and felt it had great potential. But it didn&rsquo;t support Python 3 at that time, so I&rsquo;ve decided to wait. Now, Scrapy 1.1 is released. Along with updated features, it also has">


<meta itemprop="datePublished" content="2016-02-28T10:23:00&#43;08:00" />
<meta itemprop="dateModified" content="2016-02-28T10:23:00&#43;08:00" />
<meta itemprop="wordCount" content="2008">

  <meta itemprop="image" content="https://city.shaform.com/images/2019/cobweb.jpg">



<meta itemprop="keywords" content="Python 3,Scrapy,PTT," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://city.shaform.com/images/2019/cobweb.jpg"/>

<meta name="twitter:title" content="Scrapy &#43; Python 3: PTT Data Scraping and Analysis"/>
<meta name="twitter:description" content="Scrapy 1.1 with Python 3 Support Long long time ago, I wanted to learn about web crawling to scrape some data from the PTT forum to see what could be done with it. I found the Scrapy framework, and felt it had great potential. But it didn&rsquo;t support Python 3 at that time, so I&rsquo;ve decided to wait. Now, Scrapy 1.1 is released. Along with updated features, it also has"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-13132274-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</head>
<body>
  
  <div class="header-container" style="background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('https://city.shaform.com/images/background.jpg'); background-position: center; background-size: cover;">
  <div class="container">
  <nav class="header-nav navbar navbar-expand-md navbar-dark light-dark">
    <div class="header-logo navbar-brand">
      
        <a class="float-left" href="https://city.shaform.com/en/">
      
        
        <img class="mr20 header-logo-image" src="https://city.shaform.com/images/fly.png" alt="logo">
        
        
          City of Wings
         
      </a>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="nav-menu collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://city.shaform.com/en/category/ideas/">Ideas</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://city.shaform.com/en/category/notes/">Notes</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://city.shaform.com/en/category/projects/">Projects</a>
              
            
          </li>
        
          <li class="nav-item">
            
              
                <a class="nav-link" href="https://www.google.com/search?q=site:city.shaform.com">Search</a>
              
            
          </li>
        
        
          
            <li class="nav-item">
              <a class="nav-link" href="https://city.shaform.com/zh/"><i class="fas fa-globe"></i> 繁體中文</a>
            </li>
          
          
          
          
        
      </ul>
    </div>
  </nav>
</div>

<div class="container header-wrapper">
  <div class="row">
    <div class="col-lg-12">
      <div class="header-content">
        <h1 class="header-title">Scrapy &#43; Python 3: PTT Data Scraping and Analysis</h1>
        <p class="header-date">By
          Yong-Siang Shih /
        
        Sun 28 February 2016
          / In categories
          <a href="https://city.shaform.com/en/category/notes/">Notes</a>
        </p>
        
        <div class="header-underline"></div>
        
          <div class="clearfix"></div>
          <p class="float-right header-tags">
              <i class="fas fa-tags" aria-hidden="true"></i>
              <a href="https://city.shaform.com/en/tag/ptt/">PTT</a>, 
                <a href="https://city.shaform.com/en/tag/python-3/">Python 3</a>, 
                <a href="https://city.shaform.com/en/tag/scrapy/">Scrapy</a>
          </p>
        
        <div class="clearfix"></div>
<p class="float-right translations">
    <i class="fas fa-language" aria-hidden="true"></i>
    Translations: 
    <a href="https://city.shaform.com/zh/2016/02/28/scrapy/">ZH</a>
</p>


      </div>
    </div>
  </div>
</div>

  </div>
<div class="container content">
  

<h2 id="scrapy-1-1-with-python-3-support">Scrapy 1.1 with Python 3 Support</h2>

<p>Long long time ago, I wanted to learn about web crawling to scrape some data from the <a href="https://www.ptt.cc/bbs/index.html">PTT</a> forum to see what could be done with it.
I found the <a href="http://scrapy.org/">Scrapy</a> framework, and felt it had great potential. But it didn&rsquo;t support <a href="http://cyrille.rossant.net/why-you-should-move-to-python-3-now/">Python 3</a> at that time, so I&rsquo;ve decided to wait.</p>

<p>Now, <a href="https://pypi.python.org/pypi/Scrapy/1.1.0">Scrapy 1.1</a> is released. Along with updated features, it also has <a href="https://github.com/scrapy/scrapy/issues/263">basic Python 3 support</a>. So I&rsquo;ve decided to test about it and start writing a web scraper.</p>


<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box aligncenter">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2019/cobweb.jpg" alt="Coweb" />
    </div>
    
  </figure>
</div>


<h2 id="environment-setup">Environment Setup</h2>

<p>Because I am going to scrape data from PTT forum, I&rsquo;ve decided to build my service on the machine inside NTU CS to minimize the possibility to be banned. I also set up a higher delay to prevent too many multiple concurrent connections.</p>

<p>If you are using your own machine, you might need to install some additional packages:</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">sudo apt-get install python3-dev libxml2-dev libxslt1-dev zlib1g-dev libffi-dev libssl-dev</span></code></pre></div></div>


<p>Now, we create our virtual environment using <a href="https://docs.python.org/3/library/venv.html">pyvenv</a> so as to install our own packages:</p>

<p><div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">pyvenv-3.5 my_env
</span><span class="hl"><span class="nb">source</span> my_env/bin/activate</span></code></pre></div></div>
pip install -U pip</p>

<p>Afterwards, install all the packages that are needed:</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># For some reasons, I need to use `python /sbin/pip3.5` instead of the following command on the machine</span>
<span class="hl">pip install <span class="nv">Scrapy</span><span class="o">==</span><span class="m">1</span>.1.0 numpy notebook scipy scikit-learn seaborn jieba</span></code></pre></div></div>


<h2 id="building-the-scraper">Building the Scraper</h2>

<p>After reading the <a href="http://doc.scrapy.org/en/latest/intro/tutorial.html">tutorial</a>, I would start building my first Scrapy crawler!</p>

<p>Firstly, create a project:</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">scrapy startproject ptt</span></code></pre></div></div>


<p>Set up download delay:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt/settings.py</span>
<span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mf">1.25</span></code></pre></div>
<p>Define some fields to extract, including content and comments:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># &lt;root_dir&gt;/ptt/items.py</span>
<span class="k">class</span> <span class="nc">PostItem</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span></code></pre></div>
<p>Start modifying <code>&lt;root_dir&gt;/ptt/spiders/ptt.py</code> to actually build the scraper.</p>

<p>Firstly, let&rsquo;s test if we could actually connect to PTT:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">scrapy</span>

<span class="k">class</span> <span class="nc">PTTSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ptt&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ptt.cc&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;https://www.ptt.cc/bbs/Gossiping/index.html&#39;</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span></code></pre></div>
<p>On the <code>&lt;root_dir&gt;</code> directory (which contains <code>scrapy.cfg</code>), execute the following to start the program:</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">scrapy crawl ptt</span></code></pre></div></div>


<p>After it finished, we should find a HTML file on the current directory. The page asks us whether we are older than 18 years old.
In order to successfully scrape articles from the Gossiping board on PTT, we need to automatically answer this form in our program.
Although we could also use <a href="http://doc.scrapy.org/en/latest/topics/request-response.html#topics-request-response">cookies</a> to pretend we have answered it, here I will actually submit the form to mimic human behaviour.
(Scrapy would save the cookies generated during the process between connections.)</p>

<h3 id="automatically-answer-the-age-question">Automatically Answer the Age Question</h3>

<p>So we add a test to detect whether we are in the age question page by the <code>div.over18-notice</code> element.
Here we use <a href="https://en.wikipedia.org/wiki/XPath">XPath</a> to specify the exact position of the element. I first knew about XPath while
I was doing intern at Microsoft, so it feels familiar.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">scrapy.http</span> <span class="kn">import</span> <span class="n">FormRequest</span>

<span class="k">class</span> <span class="nc">PTTSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="n">_retries</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">MAX_RETRY</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[@class=&#34;over18-notice&#34;]&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span> <span class="o">&lt;</span> <span class="n">PTTSpider</span><span class="o">.</span><span class="n">MAX_RETRY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;retry {} times...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">))</span>
                <span class="k">yield</span> <span class="n">FormRequest</span><span class="o">.</span><span class="n">from_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span>
                                                <span class="n">formdata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;yes&#39;</span><span class="p">:</span> <span class="s1">&#39;yes&#39;</span><span class="p">},</span>
                                                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;you cannot pass&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
          <span class="c1"># ...</span></code></pre></div>
<p>We utilize <code>FormRequest</code> to send the form, and use <code>callback</code> to get back to <code>parse</code> after form is submitted.
In case the attempt failed and we locked ourself into repeat submission of the form, I also use <code>MAX_RETRY</code>
to restrict the number of submissions.</p>

<h3 id="automatically-crawl-every-article-and-go-to-next-pages">Automatically Crawl Every Article and Go to Next Pages</h3>

<p>Next, let&rsquo;s build a spider to extract links for the posts. Here we also use <a href="http://doc.scrapy.org/en/stable/topics/selectors.html">CSS Selector</a>,
<code>css('.r-ent &gt; div.title &gt; a::attr(href)')</code> to get the links of the articles.
Afterwards, we use <code>response.urljoin</code> to convert relative URLs to absolute URLs and pass them to <code>parse_post</code> for further processing.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">PTTSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">_pages</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">MAX_PAGES</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[@class=&#34;over18-notice&#34;]&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># ...</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">href</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;.r-ent &gt; div.title &gt; a::attr(href)&#39;</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">href</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
                <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_post</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">&lt;</span> <span class="n">PTTSpider</span><span class="o">.</span><span class="n">MAX_PAGES</span><span class="p">:</span>
                <span class="n">next_page</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
                    <span class="s1">&#39;//div[@id=&#34;action-bar-container&#34;]//a[contains(text(), &#34;上頁&#34;)]/@href&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">next_page</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">next_page</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;follow {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
                    <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;no next page&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;max pages reached&#39;</span><span class="p">)</span></code></pre></div>
<p>Finally, we use XPath to extract the link to next page, and automatically follow the pages.
<code>MAX_PAGES</code> is used to control the maximum number of pages to follow.</p>

<h3 id="actually-scrape-the-posts">Actually Scrape the Posts</h3>

<p>Finally, let&rsquo;s actually download the posts.
We would extract title, author, content, and comments. In addition, we record the positivity and negativity
for each comment as well as for the post.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">ptt.items</span> <span class="kn">import</span> <span class="n">PostItem</span>

<span class="k">class</span> <span class="nc">PTTSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="k">def</span> <span class="nf">parse_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">PostItem</span><span class="p">()</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
            <span class="s1">&#39;//meta[@property=&#34;og:title&#34;]/@content&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
            <span class="s1">&#39;//div[@class=&#34;article-metaline&#34;]/span[text()=&#34;作者&#34;]/following-sibling::span[1]/text()&#39;</span><span class="p">)[</span>
                <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">datetime_str</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
            <span class="s1">&#39;//div[@class=&#34;article-metaline&#34;]/span[text()=&#34;時間&#34;]/following-sibling::span[1]/text()&#39;</span><span class="p">)[</span>
                <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">,</span> <span class="s1">&#39;%a %b </span><span class="si">%d</span><span class="s1"> %H:%M:%S %Y&#39;</span><span class="p">)</span>

        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[@id=&#34;main-content&#34;]/text()&#39;</span><span class="p">)[</span>
            <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>

        <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[@class=&#34;push&#34;]&#39;</span><span class="p">):</span>
            <span class="n">push_tag</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;span.push-tag::text&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
            <span class="n">push_user</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;span.push-userid::text&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
            <span class="n">push_content</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;span.push-content::text&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;推&#39;</span> <span class="ow">in</span> <span class="n">push_tag</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="s1">&#39;噓&#39;</span> <span class="ow">in</span> <span class="n">push_tag</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">total_score</span> <span class="o">+=</span> <span class="n">score</span>

            <span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">push_user</span><span class="p">,</span>
                             <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">push_content</span><span class="p">,</span>
                             <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">})</span>

        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comments</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_score</span>
        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span>

        <span class="k">yield</span> <span class="n">item</span></code></pre></div>
<p>Finally, execute the following command. The crawler would start to scrape the posts and save them into a big JSON file:</p>

<div class="sh-highlight"><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="hl">scrapy crawl ptt -o gossip.json</span></code></pre></div></div>


<h2 id="data-analysis-in-ipython-notebook">Data Analysis in IPython Notebook</h2>

<p>After we downloaded the posts, we could start data analysis.
In this experiment, I downloaded 1881 articles from the Gossiping board on PTT.
We will use IPython Notebook to do data analysis, the experiment could be viewed on <a href="http://nbviewer.jupyter.org/github/shaform/experiments/blob/master/scrapy/PTT%20Analysis.ipynb">PTT Analysis @ nbviewer</a>.</p>

<p>Because I found the figures built with <a href="http://stanford.edu/~mwaskom/software/seaborn/">Seaborn</a> seems to be more pretty when I was watching <a href="http://www.cs109.org">CS 109</a> videos, I would try it in this experiment as well.</p>

<p>We will use the following packages:</p>

<ol>
<li><a href="http://matplotlib.org/">matplotlib</a></li>
<li><a href="http://www.numpy.org/">Numpy</a></li>
<li><a href="http://scikit-learn.org/stable/index.html">scikit-learn</a></li>
<li><a href="http://stanford.edu/~mwaskom/software/seaborn/">Seaborn</a></li>
<li><a href="https://github.com/fxsjy/jieba">Jieba Chinese segmenter</a></li>
</ol>

<p>Firstly load all packages:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">%</span><span class="n">matplotlib</span> <span class="n">notebook</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">jieba</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">sklearn.feature_extraction</span> <span class="kn">import</span> <span class="n">DictVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">LinearSVC</span>

<span class="n">sns</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">)</span></code></pre></div>
<p>And then load the articles:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># load ptt posts</span>

<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;gossip.json&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></code></pre></div>
<h3 id="comments-analysis">Comments Analysis</h3>

<p>Let&rsquo;s first figure out how many comments everyone has. Maybe this shows how addicted everyone is to PTT. But due to
privacy concern, I would not display the actual IDs here.
Firstly, compute the number of comments:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># get pushes</span>

<span class="n">total_comments</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">total_pushes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">total_hates</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
        <span class="n">total_comments</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">total_pushes</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">total_hates</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></code></pre></div>
<p>And then we could draw a figure the show the most active users.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">show_distributions</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">pushes</span><span class="p">,</span> <span class="n">hates</span><span class="p">):</span>
    <span class="n">sorted_cnts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][:</span><span class="mi">100</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">counts</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">sorted_cnts</span><span class="p">]</span>
    <span class="n">y_pushes</span> <span class="o">=</span> <span class="p">[</span><span class="n">pushes</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">sorted_cnts</span><span class="p">]</span>
    <span class="n">y_hates</span> <span class="o">=</span> <span class="p">[</span><span class="n">hates</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">sorted_cnts</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

    <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">set_color_codes</span><span class="p">(</span><span class="s1">&#39;pastel&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_pushes</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;pushes&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_hates</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;hates&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span>
           <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
           <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total comments&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="c1"># display pushes</span>
<span class="n">show_distributions</span><span class="p">(</span><span class="n">total_comments</span><span class="p">,</span> <span class="n">total_pushes</span><span class="p">,</span> <span class="n">total_hates</span><span class="p">)</span></code></pre></div>
<p>As we could see, most users have positive comments, but there are also some users post a lot of negative comments!</p>

<h4 id="how-many-users-have-a-specific-number-of-comments">How Many Users Have a Specific Number of Comments?</h4>



<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img  itemprop="thumbnail" src="/images/2016/push.png" alt="Push" />
    </div>
    
  </figure>
</div>


<h3 id="word-analysis">Word Analysis</h3>

<p>Let&rsquo;s see what kinds of words are strongly correlated to negative and positive
responses. And what kinds of words are most frequently used in positive and negative
comments.</p>

<p>Firstly, use Jieba segmenter to segment the texts and collect the words.
We also record the positivity and negativity of each article.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># grap post</span>
<span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">l</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span></code></pre></div>
<p>We also process comments in the same way.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># grap comments</span>
<span class="n">c_words</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">c_scores</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">l</span> <span class="ow">and</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">c_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">c_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></code></pre></div>
<p>Finally, use <code>TfidfTransformer</code> to build the feature vector, and use <code>LinearSVC</code> to train a classifier,</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># convert to vectors</span>
<span class="n">dvec</span> <span class="o">=</span> <span class="n">DictVectorizer</span><span class="p">()</span>
<span class="n">tfidf</span> <span class="o">=</span> <span class="n">TfidfTransformer</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">tfidf</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dvec</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">words</span><span class="p">))</span>

<span class="n">c_dvec</span> <span class="o">=</span> <span class="n">DictVectorizer</span><span class="p">()</span>
<span class="n">c_tfidf</span> <span class="o">=</span> <span class="n">TfidfTransformer</span><span class="p">()</span>
<span class="n">c_X</span> <span class="o">=</span> <span class="n">c_tfidf</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">c_dvec</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">c_words</span><span class="p">))</span>

<span class="n">svc</span> <span class="o">=</span> <span class="n">LinearSVC</span><span class="p">()</span>
<span class="n">svc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>

<span class="n">c_svc</span> <span class="o">=</span> <span class="n">LinearSVC</span><span class="p">()</span>
<span class="n">c_svc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">c_X</span><span class="p">,</span> <span class="n">c_scores</span><span class="p">)</span></code></pre></div>
<p>And then we could make the figure,</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">display_top_features</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">top_n</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="nb">abs</span><span class="p">):</span>
    <span class="n">top_features</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">names</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">select</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)[:</span><span class="n">top_n</span><span class="p">]</span>
    <span class="n">top_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">top_features</span><span class="p">]</span>
    <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">top_features</span><span class="p">]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
    <span class="n">bars</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">top_weights</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">top_weights</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bar</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.30</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ind</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">top_names</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontname&#39;</span><span class="p">:</span> <span class="s1">&#39;Droid Sans Fallback&#39;</span><span class="p">,</span> <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">})</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></code></pre></div>
<p>Originally I want to show positive and negative words in the same figure, but I found that
negative words dominate the figure, so I put them into different figures.</p>

<p>Firstly, let&rsquo;s see the negative words in posts. Not sure why, but when the posts mention <code>妹妹</code>, they are more likely to attract negative responses.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># top features for posts</span>
<span class="n">display_top_features</span><span class="p">(</span><span class="n">svc</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dvec</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(),</span> <span class="mi">30</span><span class="p">)</span></code></pre></div>
<h4 id="negative-words-in-posts">Negative Words in Posts</h4>



<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img  itemprop="thumbnail" src="/images/2016/negative.png" alt="Negative" />
    </div>
    
  </figure>
</div>


<p>Unfortunately, no interesting patterns are observed for positive words in posts.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># top positive features for posts</span>
<span class="n">display_top_features</span><span class="p">(</span><span class="n">svc</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dvec</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(),</span> <span class="mi">30</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span></code></pre></div>
<h4 id="positive-words-in-posts">Positive Words in Posts</h4>



<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img  itemprop="thumbnail" src="/images/2016/positive.png" alt="Positive" />
    </div>
    
  </figure>
</div>


<p>The positive and negative words in comments are very interesting, the strongest features are
<code>紅明顯</code> and <code>給推</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># top features for comments</span>
<span class="n">display_top_features</span><span class="p">(</span><span class="n">c_svc</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c_dvec</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(),</span> <span class="mi">30</span><span class="p">)</span>
<span class="c1"># top positive features for comments</span>
<span class="n">display_top_features</span><span class="p">(</span><span class="n">c_svc</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c_dvec</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(),</span> <span class="mi">30</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span></code></pre></div>
<h4 id="negative-words-in-comments">Negative Words in Comments</h4>



<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img  itemprop="thumbnail" src="/images/2016/negative-push.png" alt="Negative Push" />
    </div>
    
  </figure>
</div>


<h4 id="positive-words-in-comments">Positive Words in Comments</h4>



<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img  itemprop="thumbnail" src="/images/2016/positive-push.png" alt="Positive Push" />
    </div>
    
  </figure>
</div>


<h2 id="conclusions">Conclusions</h2>

<p>Although many years have passed, <a href="http://py3readiness.org/">Python 3 support</a> still has not reach desired states, but it&rsquo;s already getting better. Hopefully more people will start programming in Python 3.</p>

<p>After I&rsquo;ve finished the analysis, I feel that PTT is really a great place to learn about the current topics people are interested about in Taiwan. Not sure whether there will be other applications.</p>

<p>The code used in this experiment is on GitHub for reference: <a href="https://github.com/shaform/experiments/tree/master/scrapy">https://github.com/shaform/experiments/tree/master/scrapy</a>.</p>

<h2 id="links">Links</h2>

<p>If you like this article, you might also be interested in <a href="/zh/2017/05/13/scrapy-cloud/">〈Scrapy Cloud + Scrapy 網路爬蟲〉</a>.</p>


  
  
    
    <div class="author-card">
    <div class="underline"></div>
    <div class="author-box">
      <div class="author-image"><a href="https://shaform.com"><img src="/images/shaform.jpg" alt="Yong-Siang Shih" /></a></div>
      <div class="author-content">
      <p class="author-title">Author</p>
      <p class="author-name">Yong-Siang Shih</p>
      <p class="author-desc">Software Engineer, Machine Learning Scientist, Open Source Enthusiast. Worked at Appier building machine learning systems, and interned at Google, IBM, and Microsoft as software engineering intern. Love to learn and build things.<br><a href="https://github.com/shaform">* Follow me on GitHub</a></p>
      </div>
    </div>
  </div>
    
  
  
<div class="disqus-comment">
<div>
<div class="comment-underline"></div>
</div>
<div class="btn btn-secondary disqus-button" id="load_disqus" onclick="load_disqus()">
  Load Disqus Comments
</div>
<div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = "https://city.shaform.com/en/2016/02/28/scrapy/";
  };
  function load_disqus() {
    
    
    if (window.location.hostname === 'localhost') return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'cityofwings';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    dsq.setAttribute('data-timestamp', +new Date());
    (document.head || document.body).appendChild(dsq);

    $('#load_disqus').remove();
  };
</script>
<noscript>Please enable JavaScript to view the
  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>

</div>


</div>
<div class="footer gradient-2">
  <div class="container footer-container ">
    <div class="row">
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        <div class="footer-title">Sitemap</div>
        <ul class="list-unstyled">
            
              
                <li><a href="https://city.shaform.com/en/tags/">Tags</a></li>
              
              
                <li><a href="https://city.shaform.com/en/categories/">Categories</a></li>
              
            
            
            
            <li><a rel="alternate" type="application/rss&#43;xml" href="https://city.shaform.com/en/index.xml"><i class="fas fa-rss-square"></i> RSS Feed</a></li>
            
            
            
              
                <li><a type="application/rss+xml" href="https://city.shaform.com/feeds/all.atom.xml"><i class="fas fa-rss-square"></i> RSS Feed (en&#43;zh)</a></li>
              
            
        </ul>
      </div>
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        
      </div>
      <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
        
        <div class="footer-title">Links</div>
        <ul class="list-unstyled">
          
          <li><a href="https://shaform.com/" rel="noopener" target="_blank">About Me</a></li>
          
          <li><a href="https://island.shaform.com/en/" rel="noopener" target="_blank">An Island</a></li>
          
        </ul>
        
      </div> 
      <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
        <p class="pull-right text-right">
          <small><em>Proudly powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo</a></em></small><br/>
          <small><em>Theme - <a href="https://github.com/shaform/hugo-theme-den" rel="noopener" target="_blank">Den</a></em></small><br/>
          <small>
            &copy; 
            Shaform
            
              2010 -
            2019
          </small>
          
        </p>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script>
$(document).ready(function() {
  if ($('#load_disqus').length) {
    $(window).scroll(function() {
      if ($('#load_disqus').length) {
        var elementTop = $('#load_disqus').offset().top;
        var viewportTop = $(window).scrollTop();
        var viewportBottom = viewportTop + $(window).height();
        if (viewportTop < elementTop && elementTop < viewportBottom) {
          load_disqus();
        }
      }
    });
  }
});
</script>

</body>
</html>
