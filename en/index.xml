<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:webfeeds="http://webfeeds.org/rss/1.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>City of Wings</title>
    <link>https://city.shaform.com/en/</link>
    <description>Recent content on City of Wings</description><webfeeds:icon>https://city.shaform.com/favicon.ico</webfeeds:icon>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <lastBuildDate>Tue, 15 Jan 2019 18:10:00 -0500</lastBuildDate>
    
    <atom:link href="https://city.shaform.com/en/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>Sort Sequences for PackedSequence in PyTorch</title>
      <link>https://city.shaform.com/en/2019/01/15/sort-sequences-in-pytorch/</link>
      <pubDate>Tue, 15 Jan 2019 18:10:00 -0500</pubDate>
      
      <guid>https://city.shaform.com/en/2019/01/15/sort-sequences-in-pytorch/</guid>
      <description>Introduction Although using PackedSequence in PyTorch allows faster processing for sequential data, there is something inconvenient: the sequences must be sorted according to lengths in a batch. If we are doing Seq2Seq such as machine translation, there exist input and output sequences, and their lengths might not match. We could simply sort the sequences according to lengths of input and only use PackedSequence in encoder while not using it in decoder.</description>
      <content:encoded><![CDATA[<h2 id="introduction">Introduction</h2>
<p>Although using <a href="https://pytorch.org/docs/stable/nn.html#torch.nn.utils.rnn.PackedSequence">PackedSequence</a> in <a href="https://pytorch.org/">PyTorch</a> allows faster processing for sequential data, there is something inconvenient: the sequences must be sorted according to lengths in a batch.
If we are doing <a href="https://pytorch.org/tutorials/intermediate/seq2seq_translation_tutorial.html">Seq2Seq</a> such as machine translation, there exist input and output sequences, and their lengths might not match.
We could simply sort the sequences according to lengths of input and only use PackedSequence in encoder while not using it in decoder.
But there is another approach: sort sequences again for decoder and <em>unsort</em> the output later. This note is about the second approach.</p>
<p>P.s., the newer version of PyTorch is going to have <a href="https://github.com/pytorch/pytorch/pull/15225">built-in support for this</a>, once it&rsquo;s released, it&rsquo;s no longer needed to implement it by ourselves.</p>

<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2019/geese.jpg" alt="Order" />
    </div>
    
  </figure>
</div>

<h2 id="sort-the-sequences">Sort the Sequences</h2>
<p>Firstly, we define a function <code>sort_sequences</code> to sort <code>inputs</code> according to lengths. Three outputs are returned: the sorted data, <code>inputs</code>, sorted lengths, <code>lengths_sorted</code>, and a <code>unsorted_idx</code>, which could be used to unsort data later.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sort_sequences</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">lengths</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;sort_sequences
</span></span></span><span class="line"><span class="cl"><span class="s2">    Sort sequences according to lengths descendingly.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param inputs (Tensor): input sequences, size [B, T, D]
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param lengths (Tensor): length of each sequence, size [B]
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lengths_sorted</span><span class="p">,</span> <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_</span><span class="p">,</span> <span class="n">unsorted_idx</span> <span class="o">=</span> <span class="n">sorted_idx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">inputs</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">],</span> <span class="n">lengths_sorted</span><span class="p">,</span> <span class="n">unsorted_idx</span>
</span></span></code></pre></div><h2 id="using-sort_sequences-in-rnns">Using <code>sort_sequences</code> in RNNs</h2>
<p>Before feeding the data into RNNs, use <code>sort_sequences</code> to sort the data, and then use <code>pack_padded_sequence</code> to convert the data into <code>PackedSequence</code>.</p>
<p>Afterwards, we could use <code>unsorted_idx</code> to unsort both output and output hidden vectors.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RNN</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">lengths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hidden</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="n">lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">inputs</span><span class="p">,</span> <span class="n">sorted_lengths</span><span class="p">,</span> <span class="n">unsorted_idx</span> <span class="o">=</span> <span class="n">sort_sequences</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="n">inputs</span><span class="p">,</span> <span class="n">lengths</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">pack_padded_sequence</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="n">inputs</span><span class="p">,</span> <span class="n">sorted_lengths</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">outputs</span><span class="p">,</span> <span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="n">lengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">outputs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">rnn</span><span class="o">.</span><span class="n">pad_packed_sequence</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="n">outputs</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">unsorted_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">unsorted_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="n">ct</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">unsorted_idx</span><span class="p">)</span>
</span></span></code></pre></div><p>The resulting tensors could still do backpropagation as usual, so the unsorted tensors could be returned directly.</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Migrate from Pelican and WordPress to Hugo</title>
      <link>https://city.shaform.com/en/2018/07/22/migrate-from-pelican-and-wordpress-to-hugo/</link>
      <pubDate>Sun, 22 Jul 2018 14:30:00 +0800</pubDate>
      
      <guid>https://city.shaform.com/en/2018/07/22/migrate-from-pelican-and-wordpress-to-hugo/</guid>
      <description>Back in 2014, I migrated my blogs to Pelican. While there were many static site generators to choose from, the reason I chose Pelican was twofold. Firstly, I was influenced by my friend who used Pelican. Secondly, I had been using Python for some time and therefore I liked the fact that Pelican was developed with Python.
Years have passed. It appears that my friend is no longer using Pelican for her blog.</description>
      <content:encoded><![CDATA[<p><a href="/zh/2014/05/17/migrate-from-pixnet-to-pelican/">Back in 2014</a>, I migrated my blogs to <a href="https://github.com/getpelican/pelican">Pelican</a>. While there were many <a href="https://www.staticgen.com/">static site generators</a> to choose from, the reason I chose Pelican was twofold. Firstly, I was influenced by <a href="https://github.com/jsliang/pelican-fresh/">my friend who used Pelican</a>. Secondly, I had been using Python for some time and therefore I liked the fact that Pelican was developed with Python.</p>
<p>Years have passed. It appears that my friend is no longer using Pelican for her blog. In addition, the development on Pelican is no longer as active as before. Moreover, Pelican gets slower as the number of articles grows. Therefore, I start to think about migrating to a new static site generator.</p>
<p>I decided to use <a href="https://gohugo.io">Hugo</a>. It&rsquo;s fast, actively developed, and it&rsquo;s built with <a href="https://golang.org">Go</a>, which I also use from time to time.</p>
<p>Because I want to keep the theme of <em>City of Wings</em>, I spent most of my time porting <a href="https://github.com/molivier/nest">Nest</a> to <a href="https://github.com/shaform/hugo-theme-den">Den</a>. Once the theme is ported, the remaining task is easy. The Markdown files do not require too much modification. Mostly I only modified the <code>{filename}</code> URLs for Pelican, and the representation of code blocks. Because it&rsquo;s a little bit troublesome to parse Markdown, I simply used <a href="http://vim.wikia.com/wiki/Recording_keys_for_repeated_jobs">Vim commands</a> to modify each file.</p>
<p>For <a href="https://island.shaform.com"><em>An Island</em></a>, it&rsquo;s a lot more complicated. To migrate from WordPress to Hugo, I built a small tool <a href="https://github.com/shaform/wp2hugo">wp2hugo</a> to download all the images in my articles and parse exported XML files and convert them to Markdown. I also manually modify <a href="https://en.support.wordpress.com/shortcodes/">WordPress Shortcodes</a> to complete the migration.</p>
<p>During the migration, I also updated the legacy URL structure of <em>City of Wings</em> that came from Blogger. In order to keep the original URLs working I used <a href="https://gohugo.io/content-management/urls/#aliases">Aliases</a> capability of Hugo to generate redirects. Finally, I also enabled multilingual support for both <em>City of Wings</em> and <em>An Island</em>.</p>
<p>The final result:</p>
<ul>
<li><a href="https://city.shaform.com/en/">City of Wings</a></li>
<li><a href="https://island.shaform.com/en/">An Island</a></li>
</ul>

<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box aligncenter">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2016/notebook-hero-workspace-minimal.jpg" alt="Notebook" />
    </div>
    
  </figure>
</div>

]]></content:encoded>
    </item>
    
    <item>
      <title>Generate RSS Feed for All Languages in Hugo</title>
      <link>https://city.shaform.com/en/2018/07/16/generate-rss-feed-for-all-languages-in-hugo/</link>
      <pubDate>Mon, 16 Jul 2018 21:30:00 +0800</pubDate>
      
      <guid>https://city.shaform.com/en/2018/07/16/generate-rss-feed-for-all-languages-in-hugo/</guid>
      <description>Hugo supports multilingual sites natively, and it generates a RSS feed for each sub-site of different language. However, it might be desirable to generate a global feed that includes all articles in all sub-sites.
One possibility is to define a custom output format for homepage in config.toml:
[outputs] home = [&amp;#34;HTML&amp;#34;, &amp;#34;RSS&amp;#34;, &amp;#34;FEED&amp;#34;] [mediaTypes] [mediaTypes.&amp;#34;application/rss&amp;#34;] suffixes = [&amp;#34;xml&amp;#34;] [outputFormats] [outputFormats.FEED] mediatype = &amp;#34;application/rss&amp;#34; baseName = &amp;#34;feed&amp;#34; In layouts/index.feed.xml, we then use the following range loop to iterate though all pages in all languages:</description>
      <content:encoded><![CDATA[<p><a href="http://gohugo.io">Hugo</a> supports multilingual sites natively, and it generates a RSS feed
for each sub-site of different language. However, it might be desirable to generate a global feed that includes
all articles in all sub-sites.</p>
<p>One possibility is to define a custom output format for homepage in <code>config.toml</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">outputs</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">home</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;HTML&#34;</span><span class="p">,</span> <span class="s2">&#34;RSS&#34;</span><span class="p">,</span> <span class="s2">&#34;FEED&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">mediaTypes</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">mediaTypes</span><span class="p">.</span><span class="s2">&#34;application/rss&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">suffixes</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;xml&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">outputFormats</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">outputFormats</span><span class="p">.</span><span class="nx">FEED</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">mediatype</span> <span class="p">=</span> <span class="s2">&#34;application/rss&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">baseName</span> <span class="p">=</span> <span class="s2">&#34;feed&#34;</span>
</span></span></code></pre></div><p>In <code>layouts/index.feed.xml</code>, we then use the following <code>range</code> loop to iterate though all pages in all languages:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">{{ range .Site.AllPages }}
</span></span><span class="line"><span class="cl">{{ if .IsPage }}
</span></span></code></pre></div><p>Of course, the generated location would still be under the language prefix <code>lang-code/</code>. So to make it appear &ldquo;global&rdquo; you might need to manually copy it to the root directory.</p>
<p>In addition, I also wrote a simple Python
script to combine RSS feeds from different languages.</p>
<p>Basically, it grabs all feeds and merges them into a single feed.</p>
<p>Firstly, I use <code>lxml</code> to load and parse the RSS feeds.
We define <code>root_dir</code> as the root directory of the published site,
which is usually a directory called <code>public</code>, and <code>paths</code> are the
relative paths of the RSS files, which are usually <code>{LANG_CODE}/index.xml</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_feeds</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">feeds</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">feeds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">infile</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">feeds</span>
</span></span></code></pre></div><p>We would assume there are only two sub-sites to simplify the
logic, but it&rsquo;s easy to extend it to handle more sites.
This is left as an exercise for the readers.</p>
<p>Secondly, we use <code>pytoml</code> to load the configuration file <code>config.toml</code>, and
obtain the <code>baseURL</code> of the site. This would be used to set the
location of the global RSS feed.</p>
<p>In addition, we obtain all entries from each feed and sort the entries
by their published date.</p>
<p>Finally we inject all items into a RSS file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">toml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NAMESPACES</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;atom&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.w3.org/2005/Atom&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">D_FORMAT</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%a</span><span class="s1">, </span><span class="si">%d</span><span class="s1"> %b %Y %H:%M:%S %z&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">process_feeds</span><span class="p">(</span><span class="n">main_feed</span><span class="p">,</span> <span class="n">alt_feed</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">config_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">config</span> <span class="o">=</span> <span class="n">toml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">base_url</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;baseURL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">link_node</span> <span class="o">=</span> <span class="n">main_feed</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//rss/channel/link&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">link_node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">base_url</span>
</span></span><span class="line"><span class="cl">    <span class="n">atom_node</span> <span class="o">=</span> <span class="n">main_feed</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;//rss/channel/atom:link&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">NAMESPACES</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">atom_node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_build_node</span> <span class="o">=</span> <span class="n">main_feed</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//rss/channel/lastBuildDate&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">last_build_alt_node</span> <span class="o">=</span> <span class="n">alt_feed</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//rss/channel/lastBuildDate&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">last_build_node</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">D_FORMAT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">last_build_alt_node</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">D_FORMAT</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">last_build_node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">last_build_alt_node</span><span class="o">.</span><span class="n">text</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">all_items</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">main_items</span> <span class="o">=</span> <span class="n">main_feed</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//rss/channel/item&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">all_items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">main_items</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">alt_feed</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//rss/channel/item&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;pubDate&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">D_FORMAT</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">channel</span> <span class="o">=</span> <span class="n">main_feed</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//rss/channel&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">main_items</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">all_items</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">getchildren</span><span class="p">()),</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">main_feed</span>
</span></span></code></pre></div><p>The command line options could be handled by the following code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Parsing arguments</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Merge RSS feeds.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;--root-dir&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;publish root directory&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;output rss file&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--input&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path of the feeds&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--config&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path of the config&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">feeds</span> <span class="o">=</span> <span class="n">load_feeds</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">feed</span> <span class="o">=</span> <span class="n">process_feeds</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">feeds</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">config_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">feed</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>Running this script would produce a combined RSS feed at <code>output</code> path.
This is also how the current global RSS feed for City of Wings is generated.</p>

<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box aligncenter">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2016/notebook-hero-workspace-minimal.jpg" alt="Notebook" />
    </div>
    
  </figure>
</div>

]]></content:encoded>
    </item>
    
    <item>
      <title>Install TensorFlow and Caffe on Ubuntu 16.04 with Anaconda</title>
      <link>https://city.shaform.com/en/2017/10/23/install-tensorflow-and-caffe-on-ubuntu/</link>
      <pubDate>Mon, 23 Oct 2017 21:30:00 +0800</pubDate>
      
      <guid>https://city.shaform.com/en/2017/10/23/install-tensorflow-and-caffe-on-ubuntu/</guid>
      <description>Previously I have written about 在Ubuntu 安裝 TensorFlow 的紀錄 (Installing TensorFlow on Ubuntu). Years have passed, and even though Ubuntu is still on 16.04，TensorFlow has already made great progress. I&amp;rsquo;ve decided to write another post to show how to install TensorFlow and Caffe with Anaconda. GPU</description>
      <content:encoded><![CDATA[<p>Previously I have written about <a href="/zh/2016/10/31/install-tensorflow-with-cuda/">在Ubuntu 安裝 TensorFlow 的紀錄 (Installing
TensorFlow on Ubuntu)</a>.  Years have passed, and even though
Ubuntu is still on 16.04，TensorFlow has already made great progress.  I&rsquo;ve
decided to write another post to show how to install TensorFlow and Caffe with
Anaconda.</p>
<h2 id="gpu-settings">GPU Settings</h2>
<h3 id="basic">Basic</h3>
<p>Firstly set integrated video card as the main GPU in the BIOS, and connect your
monitor to the output port of the integrated video card so your Nvidia GPU is
completely dedicated to deep learning computation.</p>
<h3 id="install-cuda">Install CUDA</h3>
<p>Afterwards, download the deb files from <a href="https://developer.nvidia.com/cuda-downloads">the download page of
CUDA</a>.  Do not install at this time. We would reboot Ubuntu and
enter <code>Ctrl-Alt-F1</code> to login via terminal.</p>
<p>Execute the following command to stop <code>lightdm</code>.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">sudo service lightdm stop</span></span></code></pre></div></div>

<p>According to <a href="https://gist.github.com/bearpaw/c38ef18ec45ba6548ec0">this article</a>, this must be done when you want to
use your Nvidia GPU solely for CUDA. When this is not done, we might not be
able to login to the desktop after CUDA installation.</p>
<p>So now we would install CUDA 8.0.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">sudo dpkg -i cuda-repo-&lt;distro&gt;_&lt;version&gt;_&lt;architecture&gt;.deb
</span></span><span class="line hl"><span class="cl">sudo apt update
</span></span><span class="line hl"><span class="cl">sudo apt install cuda-8-0</span></span></code></pre></div></div>

<p>Record which version of nvidia driver is installed and add the PATH to <code>.bashrc</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$LD_LIBRARY_PATH</span>:/usr/local/cuda/lib64:/usr/local/cuda/extras/CUPTI/lib64:/usr/lib/nvidia-384
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CUDA_HOME</span><span class="o">=</span>/usr/local/cuda
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/cuda/bin
</span></span></code></pre></div><p>where <code>/usr/lib/nvidia-384</code> should point to the actual version installed.</p>
<p>Reboot again to confirm that we could login:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">sudo reboot</span></span></code></pre></div></div>

<h2 id="setup-anaconda-environment">Setup Anaconda Environment</h2>
<h3 id="install-anaconda">Install Anaconda</h3>
<p>Download Python 3 version of Anaconda at the <a href="https://www.anaconda.com/download/#linux">Anaconda download
page</a>, and execute the installation command:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">bash ~/Downloads/Anaconda3-<span class="o">{</span>VERSION<span class="o">}</span>-Linux-x86_64.sh</span></span></code></pre></div></div>

<p>Install Anaconda onto a directory such as <code>$HOME/anaconda3</code>.</p>
<h3 id="create-tensorflow-environment">Create TensorFlow Environment</h3>
<p>Activate Anaconda:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl"><span class="nb">source</span> <span class="nv">$HOME</span>/anaconda3/bin/activate</span></span></code></pre></div></div>

<p>And create a new environment named <code>tf</code>:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">conda create -n tf anaconda</span></span></code></pre></div></div>

<p>Finally activate <code>tf</code> environment:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl"><span class="nb">source</span> activate tf</span></span></code></pre></div></div>

<h2 id="install-tensorflow">Install TensorFlow</h2>
<p>Execute this command and <code>tensorflow-gpu</code>, <code>cudnn</code>, <code>cudatoolkit</code> would be
installed automatically.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">conda install tensorflow-gpu</span></span></code></pre></div></div>

<h2 id="install-caffe">Install Caffe</h2>
<p>Firstly install the required packages:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">sudo apt install build-essential
</span></span><span class="line hl"><span class="cl">conda install atlas boost gflags glog hdf5 leveldb lmdb openblas protobuf
</span></span><span class="line hl"><span class="cl">conda install -c menpo opencv3</span></span></code></pre></div></div>

<p>Download Caffe, and create the configuration file.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">git clone https://github.com/BVLC/caffe
</span></span><span class="line hl"><span class="cl"><span class="nb">cd</span> caffe
</span></span><span class="line hl"><span class="cl">cp Makefile.config.example Makefile.config</span></span></code></pre></div></div>

<p>Modify <code>Makefile.config</code>, the number in <code>python3.6</code> could be
changed to the current Python version:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl">5c5
</span></span><span class="line"><span class="cl">&lt; # USE_CUDNN := 1
</span></span><span class="line"><span class="cl"><span class="gd">---
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>&gt; USE_CUDNN := 1
</span></span><span class="line"><span class="cl">21c21
</span></span><span class="line"><span class="cl">&lt; # OPENCV_VERSION := 3
</span></span><span class="line"><span class="cl"><span class="gd">---
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>&gt; OPENCV_VERSION := 3
</span></span><span class="line"><span class="cl">25c25
</span></span><span class="line"><span class="cl">&lt; # CUSTOM_CXX := g++
</span></span><span class="line"><span class="cl"><span class="gd">---
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>&gt; CUSTOM_CXX := /usr/bin/g++-4.9
</span></span><span class="line"><span class="cl">68,69c68,69
</span></span><span class="line"><span class="cl">&lt; PYTHON_INCLUDE := /usr/include/python2.7 \
</span></span><span class="line"><span class="cl">&lt;       /usr/lib/python2.7/dist-packages/numpy/core/include
</span></span><span class="line"><span class="cl"><span class="gd">---
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>&gt; # PYTHON_INCLUDE := /usr/include/python2.7 \
</span></span><span class="line"><span class="cl">&gt; #         /usr/lib/python2.7/dist-packages/numpy/core/include
</span></span><span class="line"><span class="cl">72,75c72,75
</span></span><span class="line"><span class="cl">&lt; # ANACONDA_HOME := $(HOME)/anaconda
</span></span><span class="line"><span class="cl">&lt; # PYTHON_INCLUDE := $(ANACONDA_HOME)/include \
</span></span><span class="line"><span class="cl">&lt;       # $(ANACONDA_HOME)/include/python2.7 \
</span></span><span class="line"><span class="cl">&lt;       # $(ANACONDA_HOME)/lib/python2.7/site-packages/numpy/core/include
</span></span><span class="line"><span class="cl"><span class="gd">---
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>&gt; ANACONDA_HOME := $(HOME)/anaconda3/envs/tf
</span></span><span class="line"><span class="cl">&gt; PYTHON_INCLUDE := $(ANACONDA_HOME)/include \
</span></span><span class="line"><span class="cl">&gt;       $(ANACONDA_HOME)/include/python3.6m \
</span></span><span class="line"><span class="cl">&gt;       $(ANACONDA_HOME)/lib/python3.6/site-packages/numpy/core/include
</span></span><span class="line"><span class="cl">83,84c83,84
</span></span><span class="line"><span class="cl">&lt; PYTHON_LIB := /usr/lib
</span></span><span class="line"><span class="cl">&lt; # PYTHON_LIB := $(ANACONDA_HOME)/lib
</span></span><span class="line"><span class="cl"><span class="gd">---
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>&gt; # PYTHON_LIB := /usr/lib
</span></span><span class="line"><span class="cl">&gt; PYTHON_LIB := $(ANACONDA_HOME)/lib
</span></span><span class="line"><span class="cl">94c94
</span></span><span class="line"><span class="cl">&lt; INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include
</span></span><span class="line"><span class="cl"><span class="gd">---
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>&gt; INCLUDE_DIRS := $(PYTHON_INCLUDE)
</span></span></code></pre></div><p>Caffe can now be compiled:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">make all
</span></span><span class="line hl"><span class="cl">make pycaffe</span></span></code></pre></div></div>


<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box aligncenter">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2016/notebook-hero-workspace-minimal.jpg" alt="Notebook" />
    </div>
    
  </figure>
</div>

]]></content:encoded>
    </item>
    
    <item>
      <title>Scrapy &#43; Python 3: PTT Data Scraping and Analysis</title>
      <link>https://city.shaform.com/en/2016/02/28/scrapy/</link>
      <pubDate>Sun, 28 Feb 2016 10:23:00 +0800</pubDate>
      
      <guid>https://city.shaform.com/en/2016/02/28/scrapy/</guid>
      <description>Scrapy 1.1 with Python 3 Support Long long time ago, I wanted to learn about web crawling to scrape some data from the PTT forum to see what could be done with it. I found the Scrapy framework, and felt it had great potential. But it didn&amp;rsquo;t support Python 3 at that time, so I&amp;rsquo;ve decided to wait. Now, Scrapy 1.1 is released. Along with updated features, it also has</description>
      <content:encoded><![CDATA[<h2 id="scrapy-11-with-python-3-support">Scrapy 1.1 with Python 3 Support</h2>
<p>Long long time ago, I wanted to learn about web crawling to scrape some data from the <a href="https://www.ptt.cc/bbs/index.html">PTT</a> forum to see what could be done with it.
I found the <a href="http://scrapy.org/">Scrapy</a> framework, and felt it had great potential. But it didn&rsquo;t support <a href="http://cyrille.rossant.net/why-you-should-move-to-python-3-now/">Python 3</a> at that time, so I&rsquo;ve decided to wait.</p>
<p>Now, <a href="https://pypi.python.org/pypi/Scrapy/1.1.0">Scrapy 1.1</a> is released. Along with updated features, it also has <a href="https://github.com/scrapy/scrapy/issues/263">basic Python 3 support</a>. So I&rsquo;ve decided to test about it and start writing a web scraper.</p>

<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box aligncenter">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2019/cobweb.jpg" alt="Coweb" />
    </div>
    
  </figure>
</div>

<h2 id="environment-setup">Environment Setup</h2>
<p>Because I am going to scrape data from PTT forum, I&rsquo;ve decided to build my service on the machine inside NTU CS to minimize the possibility to be banned. I also set up a higher delay to prevent too many multiple concurrent connections.</p>
<p>If you are using your own machine, you might need to install some additional packages:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">sudo apt-get install python3-dev libxml2-dev libxslt1-dev zlib1g-dev libffi-dev libssl-dev</span></span></code></pre></div></div>

<p>Now, we create our virtual environment using <a href="https://docs.python.org/3/library/venv.html">pyvenv</a> so as to install our own packages:</p>
<p><div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">pyvenv-3.5 my_env
</span></span><span class="line hl"><span class="cl"><span class="nb">source</span> my_env/bin/activate</span></span></code></pre></div></div>
pip install -U pip</p>
<p>Afterwards, install all the packages that are needed:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># For some reasons, I need to use `python /sbin/pip3.5` instead of the following command on the machine</span>
</span></span><span class="line hl"><span class="cl">pip install <span class="nv">Scrapy</span><span class="o">==</span>1.1.0 numpy notebook scipy scikit-learn seaborn jieba</span></span></code></pre></div></div>

<h2 id="building-the-scraper">Building the Scraper</h2>
<p>After reading the <a href="http://doc.scrapy.org/en/latest/intro/tutorial.html">tutorial</a>, I would start building my first Scrapy crawler!</p>
<p>Firstly, create a project:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">scrapy startproject ptt</span></span></code></pre></div></div>

<p>Set up download delay:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># &lt;root_dir&gt;/ptt/settings.py</span>
</span></span><span class="line"><span class="cl"><span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mf">1.25</span>
</span></span></code></pre></div><p>Define some fields to extract, including content and comments:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># &lt;root_dir&gt;/ptt/items.py</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PostItem</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">author</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">date</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">content</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">comments</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">score</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">url</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</span></span></code></pre></div><p>Start modifying <code>&lt;root_dir&gt;/ptt/spiders/ptt.py</code> to actually build the scraper.</p>
<p>Firstly, let&rsquo;s test if we could actually connect to PTT:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">scrapy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PTTSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ptt&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ptt.cc&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;https://www.ptt.cc/bbs/Gossiping/index.html&#39;</span><span class="p">,</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span></span></code></pre></div><p>On the <code>&lt;root_dir&gt;</code> directory (which contains <code>scrapy.cfg</code>), execute the following to start the program:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">scrapy crawl ptt</span></span></code></pre></div></div>

<p>After it finished, we should find a HTML file on the current directory. The page asks us whether we are older than 18 years old.
In order to successfully scrape articles from the Gossiping board on PTT, we need to automatically answer this form in our program.
Although we could also use <a href="http://doc.scrapy.org/en/latest/topics/request-response.html#topics-request-response">cookies</a> to pretend we have answered it, here I will actually submit the form to mimic human behaviour.
(Scrapy would save the cookies generated during the process between connections.)</p>
<h3 id="automatically-answer-the-age-question">Automatically Answer the Age Question</h3>
<p>So we add a test to detect whether we are in the age question page by the <code>div.over18-notice</code> element.
Here we use <a href="https://en.wikipedia.org/wiki/XPath">XPath</a> to specify the exact position of the element. I first knew about XPath while
I was doing intern at Microsoft, so it feels familiar.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scrapy.http</span> <span class="kn">import</span> <span class="n">FormRequest</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PTTSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="n">_retries</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">MAX_RETRY</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[@class=&#34;over18-notice&#34;]&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span> <span class="o">&lt;</span> <span class="n">PTTSpider</span><span class="o">.</span><span class="n">MAX_RETRY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_retries</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;retry </span><span class="si">{}</span><span class="s1"> times...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_retries</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">FormRequest</span><span class="o">.</span><span class="n">from_response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">formdata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;yes&#39;</span><span class="p">:</span> <span class="s1">&#39;yes&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;you cannot pass&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># ...</span>
</span></span></code></pre></div><p>We utilize <code>FormRequest</code> to send the form, and use <code>callback</code> to get back to <code>parse</code> after form is submitted.
In case the attempt failed and we locked ourself into repeat submission of the form, I also use <code>MAX_RETRY</code>
to restrict the number of submissions.</p>
<h3 id="automatically-crawl-every-article-and-go-to-next-pages">Automatically Crawl Every Article and Go to Next Pages</h3>
<p>Next, let&rsquo;s build a spider to extract links for the posts. Here we also use <a href="http://doc.scrapy.org/en/stable/topics/selectors.html">CSS Selector</a>,
<code>css('.r-ent &gt; div.title &gt; a::attr(href)')</code> to get the links of the articles.
Afterwards, we use <code>response.urljoin</code> to convert relative URLs to absolute URLs and pass them to <code>parse_post</code> for further processing.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PTTSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_pages</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">MAX_PAGES</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[@class=&#34;over18-notice&#34;]&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">href</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;.r-ent &gt; div.title &gt; a::attr(href)&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">href</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_post</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pages</span> <span class="o">&lt;</span> <span class="n">PTTSpider</span><span class="o">.</span><span class="n">MAX_PAGES</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">next_page</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;//div[@id=&#34;action-bar-container&#34;]//a[contains(text(), &#34;上頁&#34;)]/@href&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">next_page</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">url</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">next_page</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;follow </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;no next page&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;max pages reached&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>Finally, we use XPath to extract the link to next page, and automatically follow the pages.
<code>MAX_PAGES</code> is used to control the maximum number of pages to follow.</p>
<h3 id="actually-scrape-the-posts">Actually Scrape the Posts</h3>
<p>Finally, let&rsquo;s actually download the posts.
We would extract title, author, content, and comments. In addition, we record the positivity and negativity
for each comment as well as for the post.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">datetime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ptt.items</span> <span class="kn">import</span> <span class="n">PostItem</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PTTSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">parse_post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span> <span class="o">=</span> <span class="n">PostItem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;//meta[@property=&#34;og:title&#34;]/@content&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;//div[@class=&#34;article-metaline&#34;]/span[text()=&#34;作者&#34;]/following-sibling::span[1]/text()&#39;</span><span class="p">)[</span>
</span></span><span class="line"><span class="cl">                <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">datetime_str</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;//div[@class=&#34;article-metaline&#34;]/span[text()=&#34;時間&#34;]/following-sibling::span[1]/text()&#39;</span><span class="p">)[</span>
</span></span><span class="line"><span class="cl">                <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">datetime_str</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%a</span><span class="s1"> %b </span><span class="si">%d</span><span class="s1"> %H:%M:%S %Y&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[@id=&#34;main-content&#34;]/text()&#39;</span><span class="p">)[</span>
</span></span><span class="line"><span class="cl">            <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_score</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//div[@class=&#34;push&#34;]&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">push_tag</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;span.push-tag::text&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">push_user</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;span.push-userid::text&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">push_content</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;span.push-content::text&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;推&#39;</span> <span class="ow">in</span> <span class="n">push_tag</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="s1">&#39;噓&#39;</span> <span class="ow">in</span> <span class="n">push_tag</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">total_score</span> <span class="o">+=</span> <span class="n">score</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">comments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">push_user</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">push_content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comments</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_score</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">item</span>
</span></span></code></pre></div><p>Finally, execute the following command. The crawler would start to scrape the posts and save them into a big JSON file:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">scrapy crawl ptt -o gossip.json</span></span></code></pre></div></div>

<h2 id="data-analysis-in-ipython-notebook">Data Analysis in IPython Notebook</h2>
<p>After we downloaded the posts, we could start data analysis.
In this experiment, I downloaded 1881 articles from the Gossiping board on PTT.
We will use IPython Notebook to do data analysis, the experiment could be viewed on <a href="http://nbviewer.jupyter.org/github/shaform/experiments/blob/master/scrapy/PTT%20Analysis.ipynb">PTT Analysis @ nbviewer</a>.</p>
<p>Because I found the figures built with <a href="http://stanford.edu/~mwaskom/software/seaborn/">Seaborn</a> seems to be more pretty when I was watching <a href="http://www.cs109.org">CS 109</a> videos, I would try it in this experiment as well.</p>
<p>We will use the following packages:</p>
<ol>
<li><a href="http://matplotlib.org/">matplotlib</a></li>
<li><a href="http://www.numpy.org/">Numpy</a></li>
<li><a href="http://scikit-learn.org/stable/index.html">scikit-learn</a></li>
<li><a href="http://stanford.edu/~mwaskom/software/seaborn/">Seaborn</a></li>
<li><a href="https://github.com/fxsjy/jieba">Jieba Chinese segmenter</a></li>
</ol>
<p>Firstly load all packages:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">matplotlib</span> <span class="n">notebook</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">jieba</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.feature_extraction</span> <span class="kn">import</span> <span class="n">DictVectorizer</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfTransformer</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">LinearSVC</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>And then load the articles:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># load ptt posts</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;gossip.json&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">posts</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="comments-analysis">Comments Analysis</h3>
<p>Let&rsquo;s first figure out how many comments everyone has. Maybe this shows how addicted everyone is to PTT. But due to
privacy concern, I would not display the actual IDs here.
Firstly, compute the number of comments:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># get pushes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">total_comments</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">total_pushes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">total_hates</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_comments</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">total_pushes</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">total_hates</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span></code></pre></div><p>And then we could draw a figure the show the most active users.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_distributions</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">pushes</span><span class="p">,</span> <span class="n">hates</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sorted_cnts</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][:</span><span class="mi">100</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">counts</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">sorted_cnts</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_pushes</span> <span class="o">=</span> <span class="p">[</span><span class="n">pushes</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">sorted_cnts</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_hates</span> <span class="o">=</span> <span class="p">[</span><span class="n">hates</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">sorted_cnts</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sns</span><span class="o">.</span><span class="n">set_color_codes</span><span class="p">(</span><span class="s1">&#39;pastel&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sns</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sns</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_pushes</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;pushes&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sns</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_hates</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Total </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;hates&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total comments&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># display pushes</span>
</span></span><span class="line"><span class="cl"><span class="n">show_distributions</span><span class="p">(</span><span class="n">total_comments</span><span class="p">,</span> <span class="n">total_pushes</span><span class="p">,</span> <span class="n">total_hates</span><span class="p">)</span>
</span></span></code></pre></div><p>As we could see, most users have positive comments, but there are also some users post a lot of negative comments!</p>
<h4 id="how-many-users-have-a-specific-number-of-comments">How Many Users Have a Specific Number of Comments?</h4>


<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img  itemprop="thumbnail" src="/images/2016/push.png" alt="Push" />
    </div>
    
  </figure>
</div>

<h3 id="word-analysis">Word Analysis</h3>
<p>Let&rsquo;s see what kinds of words are strongly correlated to negative and positive
responses. And what kinds of words are most frequently used in positive and negative
comments.</p>
<p>Firstly, use Jieba segmenter to segment the texts and collect the words.
We also record the positivity and negativity of each article.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># grap post</span>
</span></span><span class="line"><span class="cl"><span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">content</span> <span class="o">=</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">l</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">d</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><p>We also process comments in the same way.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># grap comments</span>
</span></span><span class="line"><span class="cl"><span class="n">c_words</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">c_scores</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">posts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">post</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">l</span> <span class="o">=</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">l</span> <span class="ow">and</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">jieba</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">d</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">c_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">comment</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">c_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</span></span></code></pre></div><p>Finally, use <code>TfidfTransformer</code> to build the feature vector, and use <code>LinearSVC</code> to train a classifier,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># convert to vectors</span>
</span></span><span class="line"><span class="cl"><span class="n">dvec</span> <span class="o">=</span> <span class="n">DictVectorizer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">tfidf</span> <span class="o">=</span> <span class="n">TfidfTransformer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">X</span> <span class="o">=</span> <span class="n">tfidf</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">dvec</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">words</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">c_dvec</span> <span class="o">=</span> <span class="n">DictVectorizer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">c_tfidf</span> <span class="o">=</span> <span class="n">TfidfTransformer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">c_X</span> <span class="o">=</span> <span class="n">c_tfidf</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">c_dvec</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">c_words</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">svc</span> <span class="o">=</span> <span class="n">LinearSVC</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">svc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">c_svc</span> <span class="o">=</span> <span class="n">LinearSVC</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">c_svc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">c_X</span><span class="p">,</span> <span class="n">c_scores</span><span class="p">)</span>
</span></span></code></pre></div><p>And then we could make the figure,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">display_top_features</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">top_n</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="nb">abs</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_features</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">names</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">select</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">top_n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">top_features</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">top_features</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">bars</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">top_weights</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">top_weights</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">bar</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">width</span> <span class="o">=</span> <span class="mf">0.30</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ind</span> <span class="o">+</span> <span class="n">width</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">top_names</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fontname&#39;</span><span class="p">:</span> <span class="s1">&#39;Droid Sans Fallback&#39;</span><span class="p">,</span> <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</span></span></code></pre></div><p>Originally I want to show positive and negative words in the same figure, but I found that
negative words dominate the figure, so I put them into different figures.</p>
<p>Firstly, let&rsquo;s see the negative words in posts. Not sure why, but when the posts mention <code>妹妹</code>, they are more likely to attract negative responses.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># top features for posts</span>
</span></span><span class="line"><span class="cl"><span class="n">display_top_features</span><span class="p">(</span><span class="n">svc</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dvec</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(),</span> <span class="mi">30</span><span class="p">)</span>
</span></span></code></pre></div><h4 id="negative-words-in-posts">Negative Words in Posts</h4>


<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img  itemprop="thumbnail" src="/images/2016/negative.png" alt="Negative" />
    </div>
    
  </figure>
</div>

<p>Unfortunately, no interesting patterns are observed for positive words in posts.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># top positive features for posts</span>
</span></span><span class="line"><span class="cl"><span class="n">display_top_features</span><span class="p">(</span><span class="n">svc</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dvec</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(),</span> <span class="mi">30</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
</span></span></code></pre></div><h4 id="positive-words-in-posts">Positive Words in Posts</h4>


<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img  itemprop="thumbnail" src="/images/2016/positive.png" alt="Positive" />
    </div>
    
  </figure>
</div>

<p>The positive and negative words in comments are very interesting, the strongest features are
<code>紅明顯</code> and <code>給推</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># top features for comments</span>
</span></span><span class="line"><span class="cl"><span class="n">display_top_features</span><span class="p">(</span><span class="n">c_svc</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c_dvec</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(),</span> <span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># top positive features for comments</span>
</span></span><span class="line"><span class="cl"><span class="n">display_top_features</span><span class="p">(</span><span class="n">c_svc</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c_dvec</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">(),</span> <span class="mi">30</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
</span></span></code></pre></div><h4 id="negative-words-in-comments">Negative Words in Comments</h4>


<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img  itemprop="thumbnail" src="/images/2016/negative-push.png" alt="Negative Push" />
    </div>
    
  </figure>
</div>

<h4 id="positive-words-in-comments">Positive Words in Comments</h4>


<div class="box">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img  itemprop="thumbnail" src="/images/2016/positive-push.png" alt="Positive Push" />
    </div>
    
  </figure>
</div>

<h2 id="conclusions">Conclusions</h2>
<p>Although many years have passed, <a href="http://py3readiness.org/">Python 3 support</a> still has not reach desired states, but it&rsquo;s already getting better. Hopefully more people will start programming in Python 3.</p>
<p>After I&rsquo;ve finished the analysis, I feel that PTT is really a great place to learn about the current topics people are interested about in Taiwan. Not sure whether there will be other applications.</p>
<p>The code used in this experiment is on GitHub for reference: <a href="https://github.com/shaform/experiments/tree/master/scrapy">https://github.com/shaform/experiments/tree/master/scrapy</a>.</p>
<h2 id="links">Links</h2>
<p>If you like this article, you might also be interested in <a href="/zh/2017/05/13/scrapy-cloud/">〈Scrapy Cloud + Scrapy 網路爬蟲〉</a>.</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>snappycat: A command line tool to decompress snappy files produced by Hadoop</title>
      <link>https://city.shaform.com/en/2015/11/06/snappycat/</link>
      <pubDate>Fri, 06 Nov 2015 21:20:00 +0800</pubDate>
      
      <guid>https://city.shaform.com/en/2015/11/06/snappycat/</guid>
      <description>I often encounter Snappy-compressed files recently when I am learning Spark. Although we could just use sc.textFile to read them in Spark, sometimes we might want to download them locally for processing. However, reading these files locally is complicated because the file format is not exactly Snappy-compressed files, as Hadoop stores those files in its own way.
Most of existing solutions use Java to link with Hadoop library, but the setup is rather complicated.</description>
      <content:encoded><![CDATA[<p>I often encounter <a href="https://blog.cloudera.com/blog/2011/09/snappy-and-hadoop/">Snappy</a>-compressed files recently when I am learning
Spark.  Although we could just use <code>sc.textFile</code> to read them in Spark,
sometimes we might want to download them locally for processing. However,
reading these files locally is complicated because the file format is not
exactly Snappy-compressed files, as Hadoop stores those files in its own way.</p>
<p>Most of existing solutions use Java to link with Hadoop library, but the setup
is rather complicated. Moreover, some tools don&rsquo;t support empty files.
Therefore, I spent some time to study the file format.</p>
<p>In short, Hadoop split the files into multiple blocks, and each block is
compressed with Snappy independently. Before each compressed block, two 32-bit
number are used to represent the decompressed size and the compressed size,
respectively.</p>
<p>As Spark split files into multiple partitions, some partitions might be empty.
In such cases, the files would only contain two 32-bit 0s.</p>
<p>I developed a short C++ program to handle these cases: <a href="https://github.com/shaform/snappycat">snappycat</a>.</p>
<p>The usage is simple, just use input files as arguments:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">./snappycat DIRECTORY/*.snappy</span></span></code></pre></div></div>

<p>It also supports standard input:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">cat DIRECTARY/*.snappy <span class="p">|</span> snappycat</span></span></code></pre></div></div>

<p>The program outputs the decompressed result to standard output. So to save the output, use:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">./snappycat DIRECTORY/*.snappy &gt; output.txt</span></span></code></pre></div></div>


<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box aligncenter">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2016/notebook-hero-workspace-minimal.jpg" alt="Notebook" />
    </div>
    
  </figure>
</div>

]]></content:encoded>
    </item>
    
    <item>
      <title>Using Caffe for Sentiment Analysis</title>
      <link>https://city.shaform.com/en/2015/06/06/caffe-sentiment-analysis/</link>
      <pubDate>Sat, 06 Jun 2015 11:05:00 +0800</pubDate>
      
      <guid>https://city.shaform.com/en/2015/06/06/caffe-sentiment-analysis/</guid>
      <description>Caffe is a deep learning framework that can be used to develop neural network models. Although Caffe is usually used for image classification, it does not prevent us from utilizing it for other tasks. In this article, we outline the procedure to convert Paragraph Vectors into the LMDB format that Caffe understands, and create a simple model to train and predict the sentiment for movie reviews.
Data Preparation While in the previous post we use custom Chinese corpus for sentiment analysis, this time we utilize the scripts provided by mesnilgr/iclr15 to download the Large Movie Review Dataset so it&amp;rsquo;s easier to reproduce the results.</description>
      <content:encoded><![CDATA[<p><a href="http://caffe.berkeleyvision.org/">Caffe</a> is a deep learning framework that can be used to
develop neural network models. Although Caffe is usually used
for image classification, it does not prevent us from utilizing it
for other tasks. In this article, we outline the procedure to convert
<a href="http://arxiv.org/abs/1405.4053">Paragraph Vectors</a> into the <a href="http://symas.com/mdb/">LMDB</a> format that Caffe understands, and
create a simple model to train and predict the sentiment for movie reviews.</p>
<h2 id="data-preparation">Data Preparation</h2>
<p>While in the <a href="/zh/2015/03/27/sentiment-analysis/">previous post</a> we use custom Chinese corpus
for sentiment analysis, this time we utilize the scripts provided
by <a href="https://github.com/mesnilgr/iclr15">mesnilgr/iclr15</a> to download the <a href="http://ai.stanford.edu/~amaas/data/sentiment/">Large Movie Review Dataset</a>
so it&rsquo;s easier to reproduce the results.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># get mesnilgr/iclr15</span>
</span></span><span class="line hl"><span class="cl">git clone https://github.com/mesnilgr/iclr15
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">mkdir -p iclr15_run
</span></span><span class="line hl"><span class="cl"><span class="nb">cd</span> iclr15_run
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get data</span>
</span></span><span class="line hl"><span class="cl">../iclr15/scripts/data.sh</span></span></code></pre></div></div>

<p>Afterwards, we create the <a href="http://arxiv.org/abs/1405.4053">Paragraph Vectors</a> for each review. Paragraph
Vectors are fixed-dimensional distributed representations for texts. Once we
convert each review into a vector, we could easily feed it into a neural network.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># extract the part to create paragraph vectors from iclr15 scripts</span>
</span></span><span class="line hl"><span class="cl">sed -e <span class="s1">&#39;/liblinear/,$d&#39;</span> ../iclr15/scripts/paragraph.sh &gt; paragraph.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># start creating the vectors</span>
</span></span><span class="line hl"><span class="cl">chmod +x paragraph.sh
</span></span><span class="line hl"><span class="cl">./paragraph.sh</span></span></code></pre></div></div>

<p>Finally, we copy the resulting files.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># copy the vectors</span>
</span></span><span class="line hl"><span class="cl"><span class="nb">cd</span> word2vec
</span></span><span class="line hl"><span class="cl">cp full-train.txt test.txt ../../
</span></span><span class="line hl"><span class="cl"><span class="nb">cd</span> ../../</span></span></code></pre></div></div>

<h2 id="converting-the-input-format">Converting the Input Format</h2>
<p>We now have two files: <code>full-train.txt</code> and <code>test.txt</code> for training and testing
respectively. These files use <a href="https://github.com/cjlin1/libsvm/blob/master/README">LIBSVM data format</a>, which can
not be used with Caffe directly. Therefore, we create a script to convert the files.</p>
<p>We will use utilities provided by <a href="http://caffe.berkeleyvision.org/installation.html#python-andor-matlab-caffe-optional">Pycaffe</a> to do the conversion; be sure to install
all the dependencies and Pycaffe itself. Notice that currently Pycaffe does not work
well on Python 3, so we&rsquo;ll use Python 2.7 here. If you don&rsquo;t want to install Pycaffe
system-wide. You could also manually set the <code>PYTHONPATH</code> variable as follows.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl"><span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PYTHONPATH</span><span class="si">}</span>:caffe-directory/python/</span></span></code></pre></div></div>

<p>In addition, install the <a href="http://lmdb.readthedocs.org/en/release/">py-lmdb</a> Python package.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">sudo pip install lmdb</span></span></code></pre></div></div>

<p>Each line in the input file begins with a label followed by a 100-dimensional array.
So we extract the data using a simple Python routine.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">num_of_dims</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">tokens</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># change label `-1&#39; to `0&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">label</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ignore the index since we already know the format</span>
</span></span><span class="line"><span class="cl">            <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">dim</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
</span></span><span class="line"><span class="cl">            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">arr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">items</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">items</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_of_dims</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span>
</span></span></code></pre></div><p>There is a well-written tutorial on creating LMDB file on
<a href="http://deepdish.io/2015/04/28/creating-lmdb-in-python/">Creating an LMDB database in Python</a>, and we&rsquo;ll adopt
a similar procedure. The only difference is that we are using <code>floats</code>
for the data, so we&rsquo;ll just use <code>array_to_datum</code> to create the <code>Datum</code>
for us.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lmdb</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">caffe.io</span> <span class="kn">import</span> <span class="n">array_to_datum</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">itemsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># set a reasonable upper limit for database size</span>
</span></span><span class="line"><span class="cl">    <span class="n">map_size</span> <span class="o">=</span> <span class="mi">10240</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">num</span> <span class="o">*</span> <span class="n">itemsize</span> <span class="o">*</span> <span class="mi">2</span> 
</span></span><span class="line"><span class="cl">    <span class="nb">print</span> <span class="s1">&#39;save </span><span class="si">{}</span><span class="s1"> instances...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">env</span> <span class="o">=</span> <span class="n">lmdb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">map_size</span><span class="o">=</span><span class="n">map_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">datum</span> <span class="o">=</span> <span class="n">array_to_datum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">str_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:08}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">env</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">txn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">txn</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">str_id</span><span class="p">,</span> <span class="n">datum</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
</span></span></code></pre></div><p>Using the complete <a href="https://github.com/shaform/experiments/blob/master/caffe_sentiment_analysis/convert.py">convert.py</a> script, we convert both
training and testing files into LMDB format.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">python convert.py full-train.txt movie-train-lmdb
</span></span><span class="line hl"><span class="cl">python convert.py test.txt movie-test-lmdb</span></span></code></pre></div></div>

<h2 id="creating-a-caffe-model">Creating a Caffe Model</h2>
<p>Finally, we create a simple NN model with <a href="https://github.com/shaform/experiments/blob/master/caffe_sentiment_analysis/nn.prototxt">nn.prototxt</a> and <a href="https://github.com/shaform/experiments/blob/master/caffe_sentiment_analysis/nn_solver.prototxt">nn_solver.prototxt</a>. Execute the
Caffe command line tool and we obtain the following results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ caffe train --solver=nn_solver.prototxt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Iteration 10000, loss = 0.142478
</span></span><span class="line"><span class="cl">Iteration 10000, Testing net (#0)
</span></span><span class="line"><span class="cl">    Test net output #0: accuracy = 0.88364
</span></span><span class="line"><span class="cl">    Test net output #1: loss = 0.284636 (* 1 = 0.284636 loss)
</span></span><span class="line"><span class="cl">Optimization Done.
</span></span></code></pre></div><h2 id="source-code">Source Code</h2>
<p>The relevant source code is on <a href="https://github.com/shaform/experiments/blob/master/caffe_sentiment_analysis/">shaform/experiments/caffe_sentiment_analysis</a>.</p>

<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box aligncenter">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2016/dots.jpg" alt="Dots" />
    </div>
    
  </figure>
</div>

]]></content:encoded>
    </item>
    
    <item>
      <title>Dine together - Payment System</title>
      <link>https://city.shaform.com/en/2015/04/20/dine-together-payment-system/</link>
      <pubDate>Mon, 20 Apr 2015 08:34:00 +0800</pubDate>
      
      <guid>https://city.shaform.com/en/2015/04/20/dine-together-payment-system/</guid>
      <description>I seldom went out for dinner due to the location of school and the lack of money when I was in NCTU. But since I have came to Taipei, I started to have opportunities to dine together with others. Once I went with a lot of people, when it comes to paying, everyone put her money on the table. But the person who collected the money and payed for us later found out the money was not enough.</description>
      <content:encoded><![CDATA[<p>I seldom went out for dinner due to the location of school and the lack
of money when I was in NCTU. But since I have came to Taipei, I started
to have opportunities to dine together with others. Once I went with
a lot of people, when it comes to  paying, everyone put her money on the
table.  But the person who collected the money and payed for us later
found out the money was not enough. However, nobody was sure who was
responsible for that. I also have lost 200-300 dollar once when I went out
with others.</p>
<p>Indeed, if we are unable to pay individually, it&rsquo;s often risky to
dine together. There are four problems that might arise: (1) some
people might pay less than required (2) there might may fake money
(3) the restaurant could also make mistakes with the amount of money
(4) some friends might quickly take away his money when the store gives
you your change, making it hard to confirm the amount.</p>
<p>Even though it might be possible to prepare the change beforehand so
I can also pay the exact amount for myself, it&rsquo;s still easy to forget
about it. So I start to wonder whether there could be a payment system
that could solve all the problems.</p>
<p>It basically works as follows. After dining, we could create a dining
event with this app and add everybody. Each person could enter his amount
and the system would check has balance and pay the amount to the friend
who are going to pay physically. The system also displays the total
amount so you could check the change from the store easily.</p>
<p>You could also take a picture with the your receipt so you could check
who does not pay enough when you later find out the money is not enough.</p>
<p>Because all the communication happens on the platform, all friends could
see your dispute, making it easy to pressure the one responsible to
pay back.</p>
<p>If he really does not want to correct the amount, you could give him
a bad review, so when he go out with others next time, everyone could
be aware of this.</p>
<p>Of course, if the system could just pay to the restaurant, then all of
this is not required.</p>
<p>This payment system may utilize peer pressure to promote their apps, so
they can make everyone uses the system and make money.</p>

<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box aligncenter">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2015/tech.jpg" alt="Tech" />
    </div>
    
  </figure>
</div>

]]></content:encoded>
    </item>
    
    <item>
      <title>Google Inbox-like Web Browsing</title>
      <link>https://city.shaform.com/en/2014/11/07/google-inbox-like-web-browsing/</link>
      <pubDate>Fri, 07 Nov 2014 18:52:00 +0800</pubDate>
      
      <guid>https://city.shaform.com/en/2014/11/07/google-inbox-like-web-browsing/</guid>
      <description>Last time, I explored the idea of designing a web browsing UI that reduces the possibility of distractions in 〈Single-minded : an Internet reader, made for readers, made by readers〉. While that idea might sound interesting, the design itself was somewhat primitive. Recently, Google has announced Inbox, a new way to handle email. And I find that many ideas behind Inbox are also applicable to web browsing as well.
Tabs as Threads For example, different tabs can be represented as different threads, and for each thread, the history can be easily represented as different &amp;rsquo;email&amp;rsquo; in the same thread.</description>
      <content:encoded><![CDATA[<p>Last time, I explored the idea of designing a web browsing UI that reduces the possibility of distractions in <a href="/en/2013/10/20/single-minded/">〈Single-minded : an Internet reader, made for readers, made by readers〉</a>. While that idea might sound interesting, the design itself was somewhat primitive. Recently, Google has announced <a href="http://www.google.com/inbox/">Inbox</a>, a new way to handle email. And I find that many ideas behind Inbox are also applicable to web browsing as well.</p>
<h2 id="tabs-as-threads">Tabs as Threads</h2>
<p>For example, different tabs can be represented as different threads, and for each thread, the history can be easily represented as different &rsquo;email&rsquo; in the same thread.</p>
<p><img src="/images/inbox-history.png" alt="History as emails"></p>
<p>Such layout provides better navigation for histories than the current design of &lsquo;back&rsquo; and &lsquo;forward&rsquo; buttons. Sophisticated text summarization techniques can also be used to enable user to get information without actually open that page.</p>
<h2 id="search-as-threads">Search as Threads</h2>
<p>Not only a tab can be represented as threads, a search attempt can also utilize the thread layout. We simply click on the empty space, and a search input field would appear. After entering the keywords, we click as many results as we like. Each click results in a different &rsquo;email&rsquo; in the same threads, and we can inspect each one later at any time. We can archive unrelavent pages and decide to mark every remaining results with a label for later use.</p>
<h2 id="unification-of-history-bookmarks-and-tabs">Unification of History, Bookmarks, and Tabs</h2>
<p>Indeed, every page marked as done (archived) is just like the old history. Every page on the inbox is just like the tabs. And every page with a label is a bookmark. In this way, we unify everything with a consistent and simple UI. We also drastically increase the possibility for the user to utilize bookmark functions.</p>
<h2 id="we-learn-everything-so-we-search-for-you">We Learn Everything, so We Search for You</h2>
<p>Since we can safely assume that any pages left in the inbox is something that the user is interested in currently. (Otherwise she should have archived it.) We can actively recommend related pages for different threads. Moreover, for those &lsquo;search threads&rsquo;, we also have the keywords used, and since the user might try to delete unwanted results from the inbox, we have relevance feedback as well. And latency is no longer an issue, as we can do the search and the show results when the user open the browser next time. So we are able to produce extremely accurate result compared to conventional search engines. And we also have the opportunity to insert related advertisment as well.</p>
<p>However, if we do use this kind of web browsing, our entire browsing history will be on the cloud. Is this acceptable?</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Single-minded : an Internet reader, made for readers, made by readers</title>
      <link>https://city.shaform.com/en/2013/10/20/single-minded/</link>
      <pubDate>Sun, 20 Oct 2013 20:25:00 +0800</pubDate>
      
      <guid>https://city.shaform.com/en/2013/10/20/single-minded/</guid>
      <description>Realization I&amp;rsquo;ve known it for a long time that it’s difficult for me to read long articles on the web. I thought it’s because of the screen. It made my eyes get tired so easily. However, when I started to read The Shallows written by Nicholas Carr, I realized that it’s not only the screen. The Internet itself is distracting.
I started to remember that, I often clicked between different tabs aimlessly.</description>
      <content:encoded><![CDATA[<h2 id="realization">Realization</h2>
<p>I&rsquo;ve known it for a long time that it’s difficult for me to read long articles on the web. I thought it’s because of the screen. It made my eyes get tired so easily. However, when I started to read The Shallows written by Nicholas Carr, I realized that it’s not only the screen. The Internet itself is distracting.</p>
<p>I started to remember that, I often clicked between different tabs aimlessly. I repeatedly opened and reopened the Facebook page or my email inbox, wasting my time getting nothing. Indeed, I realized that I was so impatient that whenever the browser was loading a new page, I would switch to another tab, because I did not want to wait for it.</p>
<p>Once I noticed this, I started to think about possible solutions to overcome this problem &ndash; a new way of browsing. If I could get rid of the waiting time, maybe tabs would no longer be needed? If I could get rid of the tabs, maybe the Internet would be less distracting.</p>
<h2 id="single-tasking">Single-tasking</h2>
<p>To focus on one time at a time when browsing, the first thing I would need to change is the bookmarks. Bookmarks are distracting. Whenever I open the browser, I need to choose between different websites, and this decision is difficult to make. Indeed, because those tiny icons always compete for my attention, I get distracted easily and forget my tasks. Instead of choosing between different websites, I should simply choose between Tasks:</p>
<p><img src="https://lh5.googleusercontent.com/F7oAKl0sAyFqQPubG8gUytcYkQgLJM0LlejSH9SmTIxXB95BZ2_KvyaxXFVFdGErcv9VABjNiV8tRBo0t3vsqKiF7zA-0jxirAgBbBV5kWqmxe8-2N7kvcI0" alt="Tasks"></p>
<p>Each Task is composed of multiple Steps, and each Step has its own history of pages. When I click on one Task, the browser would only display one page: the last viewed page of the first Step.</p>
<p><img src="https://lh3.googleusercontent.com/lyQGxP6oxBwAYs-lTUE8ND5oXe0Uo-ryYkLkODjKC9D-HVsGGhP5lFcX_HLbVO4VpSwrwPwCCvpmb9ztOJEQUMLt3NyXrHulMi8r8vleF_0mMIRB0tTSIGJs" alt="Step"></p>
<p>It shouldn&rsquo;t be allowed to open two Tasks at the same time. I must complete one Task before I can go to the home page again. This makes me focus on one thing at a time.</p>
<h2 id="never-going-back">Never Going Back</h2>
<p>When I am in a Step, I can go back and forth through history within the Step as usual. But once I proceed to the next Step, there is no going back. This design forces me to focus on one Step at a time and encourages me to complete one Step before I go on to the next. But of course, sometimes I may want to read some other references before I can complete a Step. In this case, I can push the current Step to the end of the current Task, so I can come back to it later. By pushing everything to the end, I can actually keep every Step open, but even in this case, a linear flow is still maintained.</p>
<h2 id="new-steps">New Steps</h2>
<p>Since I have no tabs, I cannot open a new page in a different tab. Instead, I open it in the current Step or in a new Step. For example, when I am reading an article, I can look up unfamiliar words in new Steps, so I can finish the current article and then look at those definitions later.</p>
<p><img src="https://lh4.googleusercontent.com/0oWiT3Xjw5XPluesbq_B07Mlvr2nNMy_27YxkiOIsE_gZauVwklXssKV3SE7rhWjoHd58SSae56WqiK9AeG4fHcrrWQQn-LoX-o5P8Cbnb_OFWAcbtEzeIJD" alt="New Steps"></p>
<h2 id="manage-the-tasks">Manage the Tasks</h2>
<p>Whenever I complete one Task, I go back to the home screen. At that time, I have the opportunity to merge my history into the original Task or create a new one. In addition, I should have an intuitive interface to easily manage the Tasks:</p>
<p><img src="https://lh5.googleusercontent.com/fZevhXmTij2mqmE_lFwg-qkLMlRfqoHsolYj2ngSaanJFsj1KBzGnLgnargdKH-krqe_b5w5PzxfACJL3ePK3uPzR4CqF7mzXwWgOZ_qBbfKSRgxy2wvQRM7" alt="Manage the Tasks"></p>
<h2 id="a-new-way-to-utilize-history">A New Way to Utilize History</h2>
<p>History is a seldom used feature. Actually, sorting web pages by visited time simply does not make sense. Sometimes I want to find some pages that I visited before, but it’s often extremely difficult to locate the exact position in history. However, with Single-minded, the history is naturally grouped for each task. It’s easy to guess where the page might be. Also, because I can preserve all history into Tasks if I want, history becomes an useful feature that I can utilize to better manage my Tasks.</p>
<h2 id="never-waiting-for-loading">Never Waiting for Loading</h2>
<p>The linear browsing makes it easy for the browser to guess which page I will read next. So it should be easy for the browser to preload the pages and completely eliminate the waiting time for me.</p>
<h2 id="final-words">Final Words</h2>
<p>I choose to publish this article because I realize that I may not have too much time to polish this idea and implement it. As you can see, this article is still very primitive. But I hope someone may be able to find something valuable in this idea, and help us escape from the distracting dilemma.</p>

<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box aligncenter">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2015/tech.jpg" alt="Tech" />
    </div>
    
  </figure>
</div>

]]></content:encoded>
    </item>
    
    <item>
      <title>Notes about Migrating from Qwerty to Dvorak</title>
      <link>https://city.shaform.com/en/2013/07/12/qwerty-to-dvorak/</link>
      <pubDate>Fri, 12 Jul 2013 18:53:00 +0800</pubDate>
      
      <guid>https://city.shaform.com/en/2013/07/12/qwerty-to-dvorak/</guid>
      <description>Windows Newer versions of Windows could use different keyboard layouts for the login screen. Just choose it when installing or add the relevant input method in language settings.
Linux Newer versions of Linux distributions also support dvorak layout when installing.
If you want to set the layout temporarily, you could also use the following commands:
setxkbmap dvorak # change to dvorak setxkbmap us # change back to qwerty Xrdp If you are using rdp to connect to remote linux servers, the keyboard layout is controlled by a separate configuration file.</description>
      <content:encoded><![CDATA[
<link rel="stylesheet" href="https://city.shaform.com/css/hugo-easy-gallery.css" />
<div class="box aligncenter">
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img class="webfeedsFeaturedVisual" itemprop="thumbnail" src="/images/2013/keyboard.jpg" alt="Keyboard" />
    </div>
    
  </figure>
</div>

<h2 id="windows">Windows</h2>
<p>Newer versions of Windows could use different keyboard layouts for the login
screen.  Just choose it when installing or add the relevant input method in
language settings.</p>
<h2 id="linux">Linux</h2>
<p>Newer versions of Linux distributions also support dvorak layout when installing.</p>
<p>If you want to set the layout temporarily, you could also use the following commands:</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">setxkbmap dvorak <span class="c1"># change to dvorak</span>
</span></span><span class="line hl"><span class="cl">setxkbmap us     <span class="c1"># change back to qwerty</span></span></span></code></pre></div></div>

<h2 id="xrdp">Xrdp</h2>
<p>If you are using rdp to connect to remote linux servers, the keyboard layout is
controlled by a separate configuration file. The file is located in
/etc/xrdp/km-****.ini, where **** is the language suffix.</p>
<p>If you are able to login the server locally while not using rdp. You could use the following
command to generate key map when you are using dvorak.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">xrdp-genkeymap km-now.ini</span></span></code></pre></div></div>

<p>Afterwards, we could use this generated file to replace the settings.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">sudo mv km-now.ini /etc/xrdp/km-0409.ini</span></span></code></pre></div></div>

<p>Of course, you may want to backup the file before you run the above command.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">sudo mv /etc/xrdp/km-0409.ini /etc/xrdp/km-0409.ini.old</span></span></code></pre></div></div>

<p>Restart the xrdp server to load the configuration.</p>
<div class="sh-highlight"><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line hl"><span class="cl">sudo /etc/init.d/xrdp restart</span></span></code></pre></div></div>

<p>However, if you are unable to login locally, you would not be able to generate
the correct file because you are unable to change keyboard layout to dvorak.
So I created a Python script to convert km-0409.ini to dvorak settings.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># xrdpkeymap_qwerty_to_dvorak.py</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">Usage: python xrdpkeymap_qwerty_to_dvorak.py km-input.ini &gt; km-output.ini
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">fileinput</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># keycodes</span>
</span></span><span class="line"><span class="cl"><span class="c1"># $ xmodmap -pk for current mapping</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ref: http://forums.fedoraforum.org/showthread.php?t=265100</span>
</span></span><span class="line"><span class="cl"><span class="n">QWERTY</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">61</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DVORAK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="mi">52</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TRANS_DICT</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">QWERTY</span><span class="p">,</span> <span class="n">DVORAK</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">re_title</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[.*\]\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">re_keydef</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Key(\d+)=(.*)\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">output_keydefs</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">TRANS_DICT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Key</span><span class="si">%d</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">buf_dict</span><span class="p">[</span><span class="n">TRANS_DICT</span><span class="p">[</span><span class="n">k</span><span class="p">]]))</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Key</span><span class="si">%d</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">buf_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[],</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">re_title</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">buf</span><span class="p">,</span> <span class="n">buf_dict</span> <span class="o">=</span> <span class="n">output_keydefs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">re_keydef</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="o">=</span> <span class="n">re_keydef</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="n">buf_dict</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># output remaining keys</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_keydefs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="vim">Vim</h2>
<p>Sometimes we cannot even restart xrdp server. We may try to use the following commands in Vim.
This enables us to use dvorak at least in Vim.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl"><span class="nx">set</span> <span class="nx">keymap</span><span class="p">=</span><span class="nx">dvorak</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nx">set</span> <span class="nx">langmap</span><span class="p">=-=</span><span class="nx">qwertyuiop</span>[]<span class="nx">sdfghjkl</span>\\;<span class="s1">&#39;zxcvbn\\,./_+QWERTYUIOP{}SDFGHJKL:\&#34;ZXCVBN&lt;&gt;?;[]&#39;</span>\\<span class="p">,</span>.<span class="nx">pyfgcrl</span>/<span class="p">=</span><span class="nx">oeuidhtns</span><span class="p">-</span>\\;<span class="nx">qjkxbwvz</span>{}\&#34;<span class="p">&lt;&gt;</span><span class="nx">PYFGCRL</span>?<span class="p">+</span><span class="nx">OEUIDHTNS_</span>:<span class="nx">QJKXBWVZ</span><span class="err">
</span></span></span></code></pre></div><h2 id="download">Download</h2>
<p>Refer to <a href="https://github.com/shaform/dvorak-tools">shaform/dvorak-tools</a> for all script files.</p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
