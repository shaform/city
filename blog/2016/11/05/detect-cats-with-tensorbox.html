<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="最近恰好有個需求是要收集大量特定物體的圖片，直覺的想法就是訓練一個該物體的偵測器，然後再用這個偵測器從大量圖片中找出符合需求的區塊。經過一番搜尋，發現 TensorBox 似乎是個用來訓練單一物體偵測器的簡單套件，於是便利用貓咪來進行了簡單的嘗試。 本文使用的套件有的是只支援 Python 2，此時執行時將會以 python 程式執行。但筆者寫的 scripts 大多是 Python...">
        <meta name="keywords" content="cats, object detection, TensorBox, TensorFlow">
        <link rel="icon" href="https://city.shaform.com/favicon.ico">

        <title>用 TensorBox 製作簡易貓貓辨識器 - 翼之都, City of Wings</title>

        <!-- Stylesheets -->
        <link href="https://city.shaform.com/theme/css/all.min.css" rel="stylesheet">
        <link href="/style/style.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="https://city.shaform.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="翼之都, City of Wings Full Atom Feed" />
        <link href="https://city.shaform.com/feeds/notes.atom.xml" type="application/atom+xml" rel="alternate" title="翼之都, City of Wings Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

        <!-- Google Analytics -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-13132274-1', 'auto');
          ga('send', 'pageview');
        </script>
        <!-- /Google Analytics -->


    </head>

    <body>

        <!-- Header -->
    <div class="header-container" style="background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('https://city.shaform.com/images/background.jpg'); background-position: center; background-size: cover;">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="https://city.shaform.com/"><img class="mr20" src="https://city.shaform.com/images/fly.png" alt="logo">翼之都, City of Wings</a>
                    </div>
                    <div class="nav pull-right">
                                <a href="https://city.shaform.com/category/ideas.html">Ideas</a>
                                <a href="https://city.shaform.com/category/notes.html">Notes</a>
                                <a href="https://city.shaform.com/category/projects.html">Projects</a>
                                <a href="https://city.shaform.com/tags.html">Tags</a>
                            <a href="https://city.shaform.com/en">- en -</a>
  
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">用 TensorBox 製作簡易貓貓辨識器</h1>
                      <p class="header-date">By <a href="https://city.shaform.com/author/shaform.html">Shaform</a>, Sat 05 November 2016, in category <a href="https://city.shaform.com/category/notes.html">Notes</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="https://city.shaform.com/tag/cats.html">cats</a>, <a href="https://city.shaform.com/tag/object-detection.html">object detection</a>, <a href="https://city.shaform.com/tag/tensorbox.html">TensorBox</a>, <a href="https://city.shaform.com/tag/tensorflow.html">TensorFlow</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>最近恰好有個需求是要收集大量特定物體的圖片，直覺的想法就是訓練一個該物體的偵測器，然後再用這個偵測器從大量圖片中找出符合需求的區塊。經過一番搜尋，發現 <a href="https://github.com/Russell91/TensorBox">TensorBox</a> 似乎是個用來訓練單一物體偵測器的簡單套件，於是便利用貓咪來進行了簡單的嘗試。</p>
<p><img alt="Detect a Cat" src="https://city.shaform.com/images/cat-detector.png"></p>
<p>本文使用的套件有的是只支援 Python 2，此時執行時將會以 <code>python</code> 程式執行。但筆者寫的 scripts 大多是 Python 3，本文中就以 <code>python3</code> 來表示。</p>
<p>本文將會用到不少套件，實際放置套件的資料夾結構如下：</p>
<div class="highlight"><pre><span></span>./
./cats
./TensorBox
./labelImg
./labels
./data
./data/train
./data/test
</pre></div>


<p>實際的程式可在 <a href="https://github.com/shaform/experiments/tree/master/cat">shaform/experiments/cat</a> 裡找到，本文只會顯示重點部份。</p>
<h2>收集資料</h2>
<p>首先我們使用 <a href="https://github.com/maxogden/cats">maxogden/cats</a> 收集好的小規模貓貓照片來進行實驗，我們將利用 <code>catmapper</code> 資料夾中的照片做為訓練資料，最後再用 <code>cat_photos</code> 裡的照片來觀看結果。</p>
<p>值得注意的是，這樣的訓練資料只有大約三百多筆，而且每張照片裡幾乎都有貓。實際上若是真的要訓練高品質的偵測器，應當收集更多的訓練資料，而且應該要加入一些沒有貓，或者有跟貓很像但不是貓的物體，來加強模型的能力。不過本文純屬示範工具用法，未免麻煩就不做深入探討了。</p>
<p>由於 TensorBox 比較支援圖片大小為 32 倍數的照片，不符時須縮放或擷取。為了方便起見我就先把圖片都轉成適當大小。首先安裝 <a href="https://python-pillow.org/">Pillow</a> 套件：</p>
<div class="sh-highlight">
<div class="highlight"><pre><span></span><span class="hll">pip3 install Pillow
</span></pre></div>


</div>
<p>緊接著寫一個程式可以將圖片裁成指定大小 608x608，然後轉成 png 檔案格式儲存：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">image_extensions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">crop_center</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span>

    <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">width</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">height</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">crop</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">indir</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">image_extensions</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">parts</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="n">fname</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">width</span> <span class="ow">and</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">height</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">crop_center</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">img</span><span class="p">:</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>
</pre></div>


<p>並且將訓練和測試資料進行處理：</p>
<div class="sh-highlight">
<div class="highlight"><pre><span></span><span class="hll">mkdir data/train data/test
</span><span class="hll">python3 crop.py --indir cats/catmapper --outdir data/train
</span><span class="hll">python3 crop.py --indir cats/cat_photos --outdir data/test
</span></pre></div>


</div>
<h2>標記貓貓</h2>
<p>緊接著，我們使用 <a href="https://github.com/tzutalin/labelImg">labelImg</a> 來針對訓練資料 <code>cats/catmapper</code> 做標記，並將標記存放在 <code>labels</code> 資料夾裡。</p>
<p>注意到 labelImg 只支援 Python 2，同時要先按照官方安裝步驟進行初始化：</p>
<div class="sh-highlight">
<div class="highlight"><pre><span></span><span class="hll"><span class="nb">cd</span> labelImg
</span><span class="hll">sudo apt-get install pyqt4-dev-tools
</span><span class="hll">sudo pip install lxml
</span><span class="hll">make all
</span><span class="hll">./labelImg.py
</span></pre></div>


</div>
<p>可以利用 <code>Ctrl-N</code>, <code>N</code>, <code>P</code> 等快速鍵，建立框框來標記貓咪，以及切換上一張、下一張照片。</p>
<p>緊接著，撰寫一個程式將標記好的資料轉成 TensorBox 能夠讀取的格式：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">indir</span><span class="p">)</span>

    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">indir</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xml&#39;</span><span class="p">):</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

            <span class="n">img_path</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
            <span class="n">rects</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">):</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;bndbox&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;xmin&#39;</span><span class="p">))</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;bndbox&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;ymin&#39;</span><span class="p">))</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;bndbox&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;xmax&#39;</span><span class="p">))</span>
                <span class="n">y2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;bndbox&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;ymax&#39;</span><span class="p">))</span>

                <span class="n">rects</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;x1&#39;</span><span class="p">:</span> <span class="n">x1</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span> <span class="n">x2</span><span class="p">,</span> <span class="s1">&#39;y1&#39;</span><span class="p">:</span> <span class="n">y1</span><span class="p">,</span> <span class="s1">&#39;y2&#39;</span><span class="p">:</span> <span class="n">y2</span><span class="p">})</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;image_path&#39;</span><span class="p">:</span> <span class="n">img_path</span><span class="p">,</span> <span class="s1">&#39;rects&#39;</span><span class="p">:</span> <span class="n">rects</span><span class="p">}</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="n">train_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>

    <span class="n">train</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[:</span><span class="n">train_offset</span><span class="p">]</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">entries</span><span class="p">[</span><span class="n">train_offset</span><span class="p">:]</span>

    <span class="n">datasets</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">train</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">prefix_name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;{}_{}_boxes.json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">prefix_name</span><span class="p">)),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">))</span>
</pre></div>


<p>將標記轉換到 <code>data</code> 資料夾之下：</p>
<div class="sh-highlight">
<div class="highlight"><pre><span></span><span class="hll">python3 extract_label.py --indir labels --outdir data
</span></pre></div>


</div>
<h2>安裝 TensorBox 並進行訓練</h2>
<p>TensorBox 似乎是只支援 Python 2，所以首先設定好 TensorFlow 的 Python 2 版本。接著還要安裝一些相依套件（因為 OpenCV 似乎比較難設定，所以我安裝系統套件）：</p>
<div class="sh-highlight">
<div class="highlight"><pre><span></span><span class="hll">sudo apt install python-opencv
</span><span class="hll">pip install Cython numpy scikit-image jupyter
</span></pre></div>


</div>
<p>接下來下載 TensorBox：</p>
<div class="sh-highlight">
<div class="highlight"><pre><span></span><span class="hll">git clone http://github.com/russell91/Tensorbox
</span><span class="hll"><span class="nb">cd</span> Tensorbox
</span><span class="hll">./download_data.sh
</span><span class="hll"><span class="nb">cd</span> utils <span class="o">&amp;&amp;</span> make <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ..
</span></pre></div>


</div>
<p>緊接著修改 <code>TensorBox/hypes/overfeat_rezoom.json</code> 對應的項目：</p>
<p>注意到，<code>train_idl</code> 和 <code>test_idl</code> 須使用絕對路徑。</p>
<div class="highlight"><pre><span></span>&quot;train_idl&quot;: &quot;/path/to/data/labels_train_boxes.json&quot;,
&quot;test_idl&quot;: &quot;/path/to/data/labels_val_boxes.json&quot;,
&quot;image_width&quot;: 608, 
&quot;image_height&quot;: 608,
&quot;grid_height&quot;: 19, 
&quot;grid_width&quot;: 19,
</pre></div>


<p>最後就是實際進行訓練了！這個會跑很久，並且把訓練的不同階段的模型存在 <code>TensorBox/output/overfeat_rezoom_{DATETIME}/save.ckpt-{iteration}</code>。由於訓練資料實在很少，所以不須訓練到太後面，可以拿前面的版本就好。</p>
<div class="sh-highlight">
<div class="highlight"><pre><span></span><span class="hll"><span class="nb">cd</span> TensorBox
</span><span class="hll">python train.py --hypes hypes/overfeat_rezoom.json --gpu <span class="m">0</span> --logdir output
</span></pre></div>


</div>
<h2>測試結果</h2>
<p>最後就用 <a href="http://jupyter.readthedocs.io/en/latest/index.html">Jupyter Notebook</a> 來檢視我們的結果，先把之前提到的 <code>save.ckpt-10000</code> 以及 <code>save.ckpt-10000.meta</code> 存到 project 根目錄。然後在根目錄用跟 TensorBox 一樣的 Python 2 環境執行：</p>
<div class="sh-highlight">
<div class="highlight"><pre><span></span><span class="hll">jupyter notebook
</span></pre></div>


</div>
<p>進行初始化：</p>
<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="kn">import</span> <span class="n">imread</span>
</pre></div>


<p>方便起見將 TensorBox 直接加到路徑，平時請勿模仿：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;./TensorBox&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">train</span> <span class="kn">import</span> <span class="n">build_forward</span>
<span class="kn">from</span> <span class="nn">evaluate</span> <span class="kn">import</span> <span class="n">add_rectangles</span>
</pre></div>


<p>最後照抄 TensorBox 的示範程式碼，更改一些檔案路徑：</p>
<div class="highlight"><pre><span></span><span class="n">model_path</span> <span class="o">=</span> <span class="s1">&#39;./save.ckpt-10000&#39;</span>
<span class="n">image_dir</span> <span class="o">=</span> <span class="s1">&#39;./data/test&#39;</span>
<span class="n">hypes_file</span> <span class="o">=</span> <span class="s1">&#39;./TensorBox/hypes/overfeat_rezoom.json&#39;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hypes_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
<span class="n">x_in</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;x_in&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;image_height&#39;</span><span class="p">],</span> <span class="n">H</span><span class="p">[</span><span class="s1">&#39;image_width&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">])</span>

<span class="k">if</span> <span class="n">H</span><span class="p">[</span><span class="s1">&#39;use_rezoom&#39;</span><span class="p">]:</span>
    <span class="n">pred_boxes</span><span class="p">,</span> <span class="n">pred_logits</span><span class="p">,</span> <span class="n">pred_confidences</span><span class="p">,</span> <span class="n">pred_confs_deltas</span><span class="p">,</span> <span class="n">pred_boxes_deltas</span> <span class="o">=</span> <span class="n">build_forward</span><span class="p">(</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">grid_area</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="s1">&#39;grid_height&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">H</span><span class="p">[</span><span class="s1">&#39;grid_width&#39;</span><span class="p">]</span>
    <span class="n">pred_confidences</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">pred_confs_deltas</span><span class="p">,</span> <span class="p">[</span><span class="n">grid_area</span> <span class="o">*</span> <span class="n">H</span><span class="p">[</span><span class="s1">&#39;rnn_len&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">])),</span>
        <span class="p">[</span><span class="n">grid_area</span><span class="p">,</span> <span class="n">H</span><span class="p">[</span><span class="s1">&#39;rnn_len&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">H</span><span class="p">[</span><span class="s1">&#39;reregress&#39;</span><span class="p">]:</span>
        <span class="n">pred_boxes</span> <span class="o">=</span> <span class="n">pred_boxes</span> <span class="o">+</span> <span class="n">pred_boxes_deltas</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">pred_boxes</span><span class="p">,</span> <span class="n">pred_logits</span><span class="p">,</span> <span class="n">pred_confidences</span> <span class="o">=</span> <span class="n">build_forward</span><span class="p">(</span>
        <span class="n">H</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">initialize_all_variables</span><span class="p">())</span>
    <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>

    <span class="n">images</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_dir</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">feed</span> <span class="o">=</span> <span class="p">{</span><span class="n">x_in</span><span class="p">:</span> <span class="n">img</span><span class="p">}</span>
        <span class="p">(</span><span class="n">np_pred_boxes</span><span class="p">,</span> <span class="n">np_pred_confidences</span><span class="p">)</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pred_boxes</span><span class="p">,</span> <span class="n">pred_confidences</span><span class="p">],</span> <span class="n">feed_dict</span><span class="o">=</span><span class="n">feed</span><span class="p">)</span>
        <span class="n">new_img</span><span class="p">,</span> <span class="n">rects</span> <span class="o">=</span> <span class="n">add_rectangles</span><span class="p">(</span>
            <span class="n">H</span><span class="p">,</span> <span class="p">[</span><span class="n">img</span><span class="p">],</span>
            <span class="n">np_pred_confidences</span><span class="p">,</span>
            <span class="n">np_pred_boxes</span><span class="p">,</span>
            <span class="n">use_stitching</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">rnn_len</span><span class="o">=</span><span class="n">H</span><span class="p">[</span><span class="s1">&#39;rnn_len&#39;</span><span class="p">],</span>
            <span class="n">min_conf</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">show_suppressed</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">new_img</span><span class="p">)</span>
</pre></div>


<p>就可以<a href="https://nbviewer.jupyter.org/github/shaform/experiments/blob/master/cat/Detect%20Cats.ipynb">在 Notebook 上看到成果</a>了！！！</p>
<p>以下分別展示一張成功和一張失敗的照片，如果增加更多訓練資料或者使用更容易辨認的物體，效果應該可以更好才是。</p>
<div style="width: 200px; margin-left: auto; margin-right: auto;">
<p><img alt="Detect a Cat Successfully" src="https://city.shaform.com/images/cat-success.png">
<img alt="Failed to Detect a Cat" src="https://city.shaform.com/images/cat-failure.png"></p>
</div>


    <div class="comments">
        <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'cityofwings';
                var disqus_identifier = 'blog/2016/11/05/detect-cats-with-tensorbox.html';
                var disqus_url = 'https://city.shaform.com/blog/2016/11/05/detect-cats-with-tensorbox.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
        <noscript>Please enable JavaScript to view the comments.</noscript>
    </div>
        
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="https://city.shaform.com/archives.html">Archives</a></li>
                            <li><a href="https://city.shaform.com/tags.html">Tags</a></li>
                            <li><a href="https://city.shaform.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Social</div>
                        <ul class="list-unstyled">
                            <li><a href="https://github.com/shaform" target="_blank">GitHub</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Links</div>
                        <ul class="list-unstyled">
                            <li><a href="https://shaform.com" target="_blank">About me</a></li>
                            <li><a href="https://shaform.wordpress.com" target="_blank">一座島</a></li>
                        </ul>
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; shaform 2010-2018</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>