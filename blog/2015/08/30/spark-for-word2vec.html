<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="先前曾提過 word2vec 可以把語料中的詞轉換成詞向量。 雖然原本提供的 word2vec 工具速度已經很快， 但是如果要訓練更大規模的語料還是需要不少時間。 例如之前在處理 ClueWeb09 時，以實驗室的機器來說，就算只處理中文部份， 也要一個月以上才能跑完。 此時除了購買更強大的機器外，如果已經有不少機器， 或許可以利用平行運算的方式來加速。 最近剛好接觸到了 Apache ...">
        <meta name="keywords" content="Scala, Spark, word embeddings, word2vec">
        <link rel="icon" href="http://city.shaform.com/favicon.ico">

        <title>用 Apache Spark 來訓練 Word2vec 詞向量 Skip-gram Word Embeddings - 翼之都, City of Wings</title>

        <!-- Stylesheets -->
        <link href="http://city.shaform.com/theme/css/all.min.css" rel="stylesheet">
        <!-- /Stylesheets -->

        <!-- RSS Feeds -->
        <link href="http://city.shaform.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="翼之都, City of Wings Full Atom Feed" />
        <link href="http://city.shaform.com/feeds/notes.atom.xml" type="application/atom+xml" rel="alternate" title="翼之都, City of Wings Categories Atom Feed" />
        <!-- /RSS Feeds -->

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->

        <!-- Google Analytics -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-13132274-1', 'auto');
          ga('send', 'pageview');
        </script>
        <!-- /Google Analytics -->

    </head>

    <body>

        <!-- Header -->
    <div class="header-container gradient">

            <!-- Static navbar -->
            <div class="container">
                <div class="header-nav">
                    <div class="header-logo">
                        <a class="pull-left" href="http://city.shaform.com/"><img class="mr20" src="http://city.shaform.com/images/fly.png" alt="logo">翼之都, City of Wings</a>
                    </div>
                    <div class="nav pull-right">
                            <a href="http://city.shaform.com/category/ideas.html">Ideas</a>
                            <a href="http://city.shaform.com/category/notes.html">Notes</a>
                            <a href="http://city.shaform.com/category/projects.html">Projects</a>
                            <a href="http://city.shaform.com/tags.html">Tags</a>
                    </div>
                </div>
            </div>
            <!-- /Static navbar -->

            <!-- Header -->
    <!-- Header -->
    <div class="container header-wrapper">
        <div class="row">
              <div class="col-lg-12">
                  <div class="header-content">
                      <h1 class="header-title">用 Apache Spark 來訓練 Word2vec 詞向量 Skip-gram Word Embeddings</h1>
                      <p class="header-date">By <a href="http://city.shaform.com/author/shaform.html">Shaform</a>, Sun 30 August 2015, in category <a href="http://city.shaform.com/category/notes.html">Notes</a></p>
                      <div class="header-underline"></div>
                      <div class="clearfix"></div>
                      <p class="pull-right header-tags">
                          <span class="glyphicon glyphicon-tags mr5" aria-hidden="true"></span>
<a href="http://city.shaform.com/tag/scala.html">Scala</a>, <a href="http://city.shaform.com/tag/spark.html">Spark</a>, <a href="http://city.shaform.com/tag/word-embeddings.html">word embeddings</a>, <a href="http://city.shaform.com/tag/word2vec.html">word2vec</a>                      </p>
                  </div>
              </div>
        </div>
    </div>
    <!-- /Header -->
            <!-- /Header -->

        </div>
        <!-- /Header -->


        <!-- Content -->
    <div class="container content">
        <p>先前曾提過 <a href="http://city.shaform.com/blog/2014/11/04/word2vec.html">word2vec 可以把語料中的詞轉換成詞向量</a>。
雖然原本提供的 <a href="https://groups.google.com/forum/#!forum/word2vec-toolkit">word2vec</a> 工具速度已經很快，
但是如果要訓練更大規模的語料還是需要不少時間。
例如之前在處理 <a href="http://www.lemurproject.org/clueweb09.php/">ClueWeb09</a> 時，以實驗室的機器來說，就算只處理中文部份，
也要一個月以上才能跑完。
此時除了購買更強大的機器外，如果已經有不少機器，
或許可以利用平行運算的方式來加速。</p>
<p>最近剛好接觸到了 <a href="https://spark.apache.org/">Apache Spark</a>，他是一個開源的運算平台，
可以運用多台電腦進行平行運算。
且因為把很多資料直接放在記憶體中處理，又比 <a href="http://hadoop.apache.org/">Apache Hadoop</a> 單純的
MapReduce 更快一些。更重要的是，他的機器學習函式庫 <a href="https://spark.apache.org/docs/latest/mllib-guide.html">MLlib</a>
已經實作了 word2vec 當中的 <a href="http://arxiv.org/pdf/1301.3781.pdf">skip-gram</a> 模型，正好可以直接拿來訓練詞向量。</p>
<h1>安裝</h1>
<p>關於如何將 Spark 安裝在一個 cluster 上，可以參考<a href="http://spark.apache.org/docs/latest/index.html">官方文件</a>。
這裡我們只簡單的安裝單機版的 Spark 方便快速的實驗。
我們將會使用 <a href="http://releases.ubuntu.com/14.04/">Ubuntu 14.04</a> 作為實驗平台。</p>
<h2>安裝 Java 8</h2>
<p>首先安裝 Java 8，如果你已經有裝了則可以跳過。</p>
<div class="highlight"><pre><span></span>sudo add-apt-repository ppa:webupd8team/java
sudo apt-get update
sudo apt-get install oracle-java8-installer
sudo apt-get install oracle-java8-set-default
</pre></div>


<h2>安裝 Apache Spark</h2>
<p>接下來，到<a href="http://spark.apache.org/downloads.html">下載頁面</a>下載 Spark，
我是選擇 Spark 1.4.1 Pre-built for Hadoop 2.6 and later 的 binary。
不過如果有新版應該變化也不大。直接解壓縮就可以用囉：</p>
<div class="highlight"><pre><span></span>tar -xzf spark-1.4.1-bin-hadoop2.6.tgz
</pre></div>


<h2>安裝 sbt</h2>
<p>因為我打算用 Scala 所以我們還得安裝 <a href="http://www.scala-sbt.org/">sbt</a> 這個 build tool。
於是依照 <a href="http://www.scala-sbt.org/download.html">sbt 的下載頁面</a>的說明安裝 sbt：</p>
<div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;deb https://dl.bintray.com/sbt/debian /&quot;</span> <span class="p">|</span> sudo tee -a /etc/apt/sources.list.d/sbt.list
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 642AC823
sudo apt-get update
sudo apt-get install sbt
</pre></div>


<h1>下載資料集</h1>
<p>為了簡單起見，使用 100MB 的 Wikipedia dump：</p>
<div class="highlight"><pre><span></span>wget http://mattmahoney.net/dc/text8.zip -O text8.gz
gzip -d text8.gz -f
</pre></div>


<p>由於是單機，所以可以放在任意資料夾，如果是在 cluster 的話，需要放在每台機器都能存取的同一位置。</p>
<h1>編寫 Spark 程式</h1>
<p>首先建立專案資料夾：</p>
<div class="highlight"><pre><span></span>mkdir -p sparkw2v/src/main/scala/
</pre></div>


<p>然後編輯 <code>sparkw2v/sparkw2v.sbt</code> 檔案，程式版本參考官方文件：</p>
<div class="highlight"><pre><span></span>name := &quot;Spark Word2Vec&quot;

version := &quot;1.0&quot;

scalaVersion := &quot;2.10.4&quot;

libraryDependencies ++= Seq(
    &quot;org.apache.spark&quot; %% &quot;spark-core&quot; % &quot;1.4.1&quot; % &quot;provided&quot;,
    &quot;org.apache.spark&quot; %% &quot;spark-mllib&quot; % &quot;1.4.1&quot;
)
</pre></div>


<p>最後則是程式碼 <code>sparkw2v/src/main/scala/SparkW2V.scala</code> 本身，注意要設定輸出入 <code>{input directory}</code> 和 <code>{output directory}</code>的路徑。
同樣的如果是在 cluster 的話，需要放在每台機器都能存取的同一位置。
Word2Vec 參數設定則可參考 <a href="https://spark.apache.org/docs/latest/api/scala/index.html#org.apache.spark.ml.feature.Word2Vec">API 文件</a>。</p>
<div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.rdd._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.SparkContext</span>
<span class="k">import</span> <span class="nn">org.apache.spark.SparkContext._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.SparkConf</span>

<span class="k">import</span> <span class="nn">org.apache.spark.mllib.feature.Word2Vec</span>

<span class="k">object</span> <span class="nc">SparkW2V</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">text8</span> <span class="k">=</span> <span class="s">&quot;{input directory}/text8&quot;</span>
    <span class="k">val</span> <span class="n">output</span> <span class="k">=</span> <span class="s">&quot;{output directory}/model&quot;</span>
    <span class="k">val</span> <span class="n">conf</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkConf</span><span class="o">().</span><span class="n">setAppName</span><span class="o">(</span><span class="s">&quot;Spark Word2Vec&quot;</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">sc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkContext</span><span class="o">(</span><span class="n">conf</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">input</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="n">text8</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot; &quot;</span><span class="o">).</span><span class="n">toSeq</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">word2vec</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Word2Vec</span><span class="o">()</span>

    <span class="k">val</span> <span class="n">model</span> <span class="k">=</span> <span class="n">word2vec</span><span class="o">.</span><span class="n">fit</span><span class="o">(</span><span class="n">input</span><span class="o">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="o">(</span><span class="n">sc</span><span class="o">,</span> <span class="n">output</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2>Build</h2>
<p>使用 sbt 進行 package：</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span> sparkw2v
sbt package
</pre></div>


<p>根據版本不同，產生的檔案名稱也不同，我的輸出是 <code>sparkw2v/target/scala-2.10/spark-word2vec_2.10-1.0.jar</code>。</p>
<h1>執行</h1>
<p>接下來就可以回到根目錄，利用 <code>spark-submit</code> 執行程式。筆者不確定記憶體的需求為何，所以開的大了些：</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span> ..
spark-1.4.1-bin-hadoop2.6/bin/spark-submit --class SparkW2V --master local<span class="o">[</span>*<span class="o">]</span> --executor-memory 20G --driver-memory 10G sparkw2v/target/scala-2.10/spark-word2vec_2.10-1.0.jar
</pre></div>


<p>輸出的向量會放在 <code>{output directory}/model/data/</code> 底下，而且是存成 <a href="https://parquet.apache.org/">Parquet</a> 的格式，不太方便。
所以我們使用 spark-shell 快速的將檔案轉成文字檔：</p>
<div class="highlight"><pre><span></span><span class="c1"># 執行 Spark Shell</span>
./spark-1.4.1-bin-hadoop2.6/bin/spark-shell

<span class="c1"># 從這裡開始是 Spark Shell</span>
<span class="c1">#</span>
<span class="c1"># Welcome to</span>
<span class="c1">#       ____              __</span>
<span class="c1">#      / __/__  ___ _____/ /__</span>
<span class="c1">#     _\ \/ _ \/ _ `/ __/  &#39;_/</span>
<span class="c1">#    /___/ .__/\_,_/_/ /_/\_\   version 1.4.1</span>
<span class="c1">#       /_/</span>
<span class="c1">#</span>

<span class="c1"># 讀取檔案</span>
scala&gt; val <span class="nv">d</span> <span class="o">=</span> sqlContext.parquetFile<span class="o">(</span><span class="s2">&quot;{output directory}/model/data/part-*.parquet&quot;</span><span class="o">)</span>
d: org.apache.spark.sql.DataFrame <span class="o">=</span> <span class="o">[</span>word: string, vector: array&lt;float&gt;<span class="o">]</span>

<span class="c1"># 檢查格式</span>
scala&gt; d.first
res2: org.apache.spark.sql.Row <span class="o">=</span> <span class="o">[</span>latifolia,ArrayBuffer<span class="o">(</span>-0.08103186, 0.14688604, -0.060668133, -0.25648367, -0.06855837, -0...

<span class="c1"># 輸出到 output directory/vectors/</span>
scala&gt; d.map<span class="o">{</span><span class="nv">r</span> <span class="o">=</span>&gt; r.getString<span class="o">(</span>0<span class="o">)</span> + <span class="s2">&quot; &quot;</span> + r.getSeq<span class="o">(</span>1<span class="o">)</span>.mkString<span class="o">(</span><span class="s2">&quot; &quot;</span><span class="o">)}</span>.saveAsTextFile<span class="o">(</span><span class="s2">&quot;{output directory}/vectors&quot;</span><span class="o">)</span>
</pre></div>


<p>如此便完成了！</p>
<h1>原始碼</h1>
<p>相關程式碼放在 <a href="https://github.com/shaform/experiments/blob/master/spark_word2vec/">shaform/experiments/spark_word2vec</a>。</p>


            <div class="comments">
                <div id="disqus_thread"></div>
                    <script type="text/javascript">
                        var disqus_shortname = 'cityofwings';
                        var disqus_identifier = 'blog/2015/08/30/spark-for-word2vec.html';
                        var disqus_url = 'http://city.shaform.com/blog/2015/08/30/spark-for-word2vec.html';
                        (function() {
                            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                <noscript>Please enable JavaScript to view the comments.</noscript>
            </div>
    </div>
        <!-- /Content --> 

        <!-- Footer -->
        <div class="footer gradient-2">
            <div class="container footer-container ">
                <div class="row">
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Sitemap</div>
                        <ul class="list-unstyled">
                            <li><a href="http://city.shaform.com/archives.html">Archives</a></li>
                            <li><a href="http://city.shaform.com/tags.html">Tags</a></li>
                            <li><a href="http://city.shaform.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">Atom Feed</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Social</div>
                        <ul class="list-unstyled">
                            <li><a href="https://github.com/shaform" target="_blank">GitHub</a></li>
                        </ul>
                    </div>
                    <div class="col-xs-4 col-sm-3 col-md-3 col-lg-3">
                        <div class="footer-title">Links</div>
                        <ul class="list-unstyled">
                            <li><a href="http://shaform.wordpress.com" target="_blank">一座島</a></li>
                        </ul>
                    </div> 
                    <div class="col-xs-12 col-sm-3 col-md-3 col-lg-3">
                        <p class="pull-right text-right">
                            <small><em>Proudly powered by <a href="http://docs.getpelican.com/" target="_blank">pelican</a></em></small><br/>
                            <small><em>Theme and code by <a href="https://github.com/molivier" target="_blank">molivier</a></em></small><br/>
                            <small>&copy; shaform 2015</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <!-- /Footer -->
    </body>
</html>