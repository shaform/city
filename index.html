<!doctype html>
<html lang="">	
<head>
	<meta charset="utf-8"/>
	<title>City of Wings - 翼之都</title>	
	<meta name="author" content="Shaform">
	

	<link rel="stylesheet" href="http://city.shaform.com/theme/css/main.css" type="text/css" />
		


    <link href="http://city.shaform.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="City of Wings - 翼之都 Atom Feed" />
</head>
	
<body>

    <div class="container">
	  
	  <header role="banner">
	    <div class="feeds">
	        <a href="http://city.shaform.com/feeds/all.atom.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="atom feed"/></a>
	    </div>
		<a href="http://city.shaform.com" class="title">City of Wings - 翼之都</a>
      </header>
	
	  <div class="wrapper">

		  <div role="main" class="content">



      <article>
        <h1><a href="http://city.shaform.com/blog/2014/06/21/fix-public-key-login-for-encrypted-home.html">解決 Ubuntu 加密 Home 目錄後無法遠端用 public key 登入的問題</a></h1>
        <p>通常啟用 SSH 登入會遇到一個大問題：經常會有奇怪的人想要暴力破解密碼，取得登入權限。最早我都是限制只能從校內 IP 來源登入來減輕這個問題，然而最近的電腦是在 NAT 背後，透過一個 port 連結 SSH，所以似乎看不到真正的來源 IP，因此無法輕易過濾。</p>
<p>我最後決定停用密碼登入的功能，改成只能用 public key 登入，這樣子可能比較難以猜中正確的密鑰。不過實際用起來偶爾會發現登入失敗搞不清楚理由，後來才發現是因為我的 Ubuntu 啟用了家目錄加密的功能，因此尚未登入之前根本讀不到 <code>authorized_keys</code> 設定檔。為了解決這個問題，必須移動設定檔的位置才行。</p>
<h2>Generate SSH Keys</h2>
<p>首先如果沒有自己的 SSH keys 的話可以參考<a href="https://help.github.com/articles/generating-ssh-keys">〈Generating SSH Keys〉</a>建立自己的 SSH keys。大致上是使用如下指令：</p>
<div class="highlight"><pre>ssh-keygen -t rsa -C <span class="s2">&quot;your_email@example.com&quot;</span>
</pre></div>


<p>預設會把產生的 private key 存在 <code>/home/$USER/.ssh/id_rsa</code>，public key 存在 <code>/home/$USER/.ssh/id_rsa.pub</code>，不過也可以改位置。passphrase 則是用來加密 private key，建議要使用，這樣子每次要解開 private key 時都需要使用密碼，所以就算一不小心 private key 被別人取得，對方也要花上一段時間才能解開。</p>
<h2>更改 sshd_config 設定</h2>
<div class="highlight"><pre>sudoedit /etc/ssh/sshd_config
</pre></div>


<p>首先取消密碼登入，將</p>
<div class="highlight"><pre><span class="c">#PasswordAuthentication yes</span>
</pre></div>


<p>改成：</p>
<div class="highlight"><pre><span class="n">PasswordAuthentication</span> <span class="n">no</span>
</pre></div>


<p>再來更動 <code>authorized_keys</code> 的位置，將</p>
<div class="highlight"><pre><span class="c">#AuthorizedKeysFile     %h/.ssh/authorized_keys</span>
</pre></div>


<p>改成：</p>
<div class="highlight"><pre><span class="n">AuthorizedKeysFile</span>     <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">keys</span><span class="o">/%</span><span class="n">u</span><span class="o">/</span><span class="n">authorized_keys</span>
</pre></div>


<h2>建立 authorized_keys 檔案</h2>
<p>然後根據你的 <code>$USER</code> 名字建立資料夾，並修改權限：</p>
<div class="highlight"><pre>sudo mkdir -p /etc/ssh/keys/<span class="nv">$USER</span>
sudo chmod 755 /etc/ssh/keys
sudo chmod 700 /etc/ssh/<span class="nv">$USER</span>
sudo chown <span class="nv">$USER</span>:<span class="nv">$USER</span> /etc/ssh/<span class="nv">$USER</span>
</pre></div>


<p>最後再將 <code>id_rsa.pub</code> 拷貝到 server 上，並複製到 authorized_keys：</p>
<div class="highlight"><pre><span class="c"># copy id_rsa.pub to server, then -&gt;</span>
cat id_rsa.pub &gt;&gt; /etc/ssh/keys/<span class="nv">$USER</span>/authorized_keys
chmod 400 /etc/ssh/ssh/keys/<span class="nv">$USER</span>/authorized_keys
</pre></div>


<h2>重新讀取設定</h2>
<p>重新讀取設定檔並測試一下登入就大功告成：</p>
<div class="highlight"><pre>sudo service ssh reload
</pre></div>
      </article>

      <hr />

        <div>
          <h3>Last posts</h3>
          <ol class="archive">
    


      <li>
<a href="http://city.shaform.com/blog/2014/06/19/install-w8-ubuntu-with-uefi.html" rel="bookmark" title="Permalink to 在 UEFI 模式下同時安裝 Windows 8.1 和 Ubuntu 14.04">在 UEFI 模式下同時安裝 Windows 8.1 和 Ubuntu 14.04</a>
  <time datetime="2014-06-19T16:05:00+08:00" pubdate>Thu 19 June 2014</time>
<p class="tags">tags: <a href="http://city.shaform.com/tag/uefi.html">UEFI</a><a href="http://city.shaform.com/tag/windows-8.html">Windows 8</a><a href="http://city.shaform.com/tag/windows-81.html">Windows 8.1</a><a href="http://city.shaform.com/tag/ubuntu-1404.html">Ubuntu 14.04</a></p></a>      </li>


      <li>
<a href="http://city.shaform.com/blog/2014/05/27/stay-on-bbs.html" rel="bookmark" title="Permalink to 簡單的 BBS 掛站設定">簡單的 BBS 掛站設定</a>
  <time datetime="2014-05-27T13:21:00+08:00" pubdate>Tue 27 May 2014</time>
<p class="tags">tags: <a href="http://city.shaform.com/tag/ptt.html">PTT</a><a href="http://city.shaform.com/tag/bbs.html">BBS</a><a href="http://city.shaform.com/tag/linux.html">linux</a></p></a>      </li>


      <li>
<a href="http://city.shaform.com/blog/2014/05/17/migrate-from-pixnet-to-pelican.html" rel="bookmark" title="Permalink to 從 Pixnet 轉移到 Pelican">從 Pixnet 轉移到 Pelican</a>
  <time datetime="2014-05-17T07:25:00+08:00" pubdate>Sat 17 May 2014</time>
<p class="tags">tags: <a href="http://city.shaform.com/tag/pixnet.html">Pixnet</a><a href="http://city.shaform.com/tag/pelican.html">Pelican</a><a href="http://city.shaform.com/tag/python.html">Python</a></p></a>      </li>


      <li>
<a href="http://city.shaform.com/blog/2014/04/13/hbase-on-ubuntu-12.04.html" rel="bookmark" title="Permalink to 在 Ubuntu 12.04 安裝 HDFS 及 HBase 筆記">在 Ubuntu 12.04 安裝 HDFS 及 HBase 筆記</a>
  <time datetime="2014-04-13T15:56:00+08:00" pubdate>Sun 13 April 2014</time>
<p class="tags">tags: <a href="http://city.shaform.com/tag/hadoop.html">Hadoop</a><a href="http://city.shaform.com/tag/hbase.html">HBase</a><a href="http://city.shaform.com/tag/hdfs.html">HDFS</a><a href="http://city.shaform.com/tag/ubuntu.html">Ubuntu</a></p></a>      </li>


      <li>
<a href="http://city.shaform.com/blog/2013/10/20/single-minded.html" rel="bookmark" title="Permalink to Single-minded : an Internet reader, made for readers, made by readers">Single-minded : an Internet reader, made for readers, made by readers</a>
  <time datetime="2013-10-20T20:25:00+08:00" pubdate>Sun 20 October 2013</time>
<p class="tags">tags: <a href="http://city.shaform.com/tag/browser.html">browser</a><a href="http://city.shaform.com/tag/internet.html">Internet</a></p></a>      </li>














          </ol>
        </div>

		  </div>	
		  
		  <div class="sidebar">
		    <div class="sidebar-container" >

	            <aside>
	              <h2>About</h2>
			      <p>
                    翼之都 - a blog by Shaform.<br>夢想，可以飛得多遠？伸出雙手，盡情實驗。
			      </p>
			    </aside>

  	          <nav>
	            <h2>Categories</h2>
	            <ul>
	                <li ><a href="http://city.shaform.com/category/ideas.html">Ideas</a></li>
	                <li ><a href="http://city.shaform.com/category/notes.html">Notes</a></li>
	                <li ><a href="http://city.shaform.com/category/projects.html">Projects</a></li>
	            </ul>
	          </nav>


                  <aside>
	            <h2>Tags</h2>
                    <ul class="tagcloud">
                      <li class="tag-4"><a href="http://city.shaform.com/tag/ubuntu-1404.html">Ubuntu 14.04</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/pelican.html">Pelican</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/ibus.html">ibus</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/python.html">Python</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/internet.html">Internet</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/browser.html">browser</a></li>
                      <li class="tag-1"><a href="http://city.shaform.com/tag/zi-you-xing-lie.html">自由行列</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/vim.html">vim</a></li>
                      <li class="tag-2"><a href="http://city.shaform.com/tag/ubuntu.html">Ubuntu</a></li>
                      <li class="tag-1"><a href="http://city.shaform.com/tag/shu-ru-fa.html">輸入法</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/google-drive.html">Google Drive</a></li>
                      <li class="tag-1"><a href="http://city.shaform.com/tag/linux.html">linux</a></li>
                      <li class="tag-1"><a href="http://city.shaform.com/tag/ruan-ti-kai-fa.html">軟體開發</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/pixnet.html">Pixnet</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/windows.html">windows</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/uefi.html">UEFI</a></li>
                      <li class="tag-2"><a href="http://city.shaform.com/tag/dvorak.html">dvorak</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/windows-8.html">Windows 8</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/ptt.html">PTT</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/public-key.html">public key</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/ssh.html">SSH</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/vimrc.html">vimrc</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/hadoop.html">Hadoop</a></li>
                      <li class="tag-2"><a href="http://city.shaform.com/tag/qwerty.html">qwerty</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/hdfs.html">HDFS</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/xing-lie.html">行列</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/hbase.html">HBase</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/windows-81.html">Windows 8.1</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/coprogramming.html">CoProgramming</a></li>
                      <li class="tag-4"><a href="http://city.shaform.com/tag/bbs.html">BBS</a></li>
                    </ul>
	          </aside>
	        </div>
		  </div>

	  </div>

      <footer>
		<p role="contentinfo">
		  Shaform - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-sober">pelican-sober</a>.
    	</p>

	  </footer>	

	</div>
	
          <script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-13132274-1', 'shaform.com');
              ga('send', 'pageview');

          </script>

</body>
</html>